<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Автоматизация писем</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a73e8;
      --sidebar-bg: #1a2a44;
      --border: #e0e7ff;
      --text: #202124;
      --bg-light: #f8f9fa;
      --hover: #e8f0fe;
      --error: #d32f2f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text); line-height: 1.5; }
    #container { display: flex; min-height: 100vh; }
    #sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: #fff;
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    #sidebar h3 { font-size: 18px; margin-bottom: 15px; font-weight: 600; }
    #sidebar button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      background: #334466;
      border: none;
      color: #fff;
      font-size: 15px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }
    #sidebar button:hover { background: #405080; }
    #sidebar button.active { background: var(--primary); font-weight: 500; }
    #main { display: none; }
    #right {
      flex: 1;
      padding: 20px;
      background: #fff;
      overflow-y: auto;
    }
    #right h3 { font-size: 18px; margin-bottom: 15px; font-weight: 600; }
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
    }
    .excel-table th, .excel-table td {
      border: 1px solid var(--border);
      padding: 10px;
      text-align: left;
    }
    .excel-table th { background: #f1f3f5; font-weight: 500; }
    .excel-table tr:hover { background: var(--hover); cursor: pointer; }
    .excel-table tr.selected { background: #d1e7ff; }
    #tableArea { max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 6px; }
    #templateArea {
      min-height: 200px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
      overflow-x: auto;
    }
    #rowInput {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #generateButton, #copyButton {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    #generateButton:hover, #copyButton:hover { background: #1557b0; }
    #finalLetter {
      min-height: 200px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 15px;
      font-size: 14px;
      overflow-x: auto;
    }
    .letter-html table { border-collapse: collapse; }
    .letter-html th, .letter-html td { border: 1px solid var(--border); padding: 6px 10px; }
    .error { color: var(--error); font-size: 14px; margin-bottom: 10px; }
    @media (max-width: 900px) {
      #container { flex-direction: column; }
      #sidebar, #right { width: 100%; }
      #sidebar { position: sticky; top: 0; z-index: 10; }
      #right { padding: 15px; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h3>Шаблоны писем</h3>
      <div id="templatesList">Загрузка...</div>
    </div>
    <div id="main"></div>
    <div id="right">
      <h3>Реестр заявок</h3>
      <div id="tableArea"></div>
      <h3>Форма письма</h3>
      <div id="templateArea" class="letter-html">Выберите шаблон письма и строку из реестра.</div>
      <input type="number" id="rowInput" placeholder="Введите номер строки реестра" min="2">
      <button id="generateButton" onclick="generateLetter()">Сформировать письмо</button>
      <div id="errorArea" class="error"></div>
      <h3>Итоговое письмо</h3>
      <button id="copyButton" onclick="copyLetter()" style="display: none;">Копировать письмо</button>
      <div id="finalLetter" class="letter-html"></div>
    </div>
  </div>
  <script>
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";
    const GOOGLE_SHEET_ID = "1-P3T-ik_gU7qrr0KGDFbxQ80F70_Z8K5QT4siN31Or4";

    let templatesMeta = [];
    let currentTemplateName = '';
    let currentTemplateContent = '';
    let excelData = [];
    let headers = [];

    async function fetchTemplatesList() {
      try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('Не удалось загрузить шаблоны');
        const files = await res.json();
        templatesMeta = files.filter(f => /\.html$/i.test(f.name));
        renderTemplatesList();
      } catch (e) {
        document.getElementById('templatesList').innerHTML = 'Ошибка загрузки шаблонов';
      }
    }

    function renderTemplatesList() {
      let html = '';
      templatesMeta.forEach((tpl, idx) => {
        html += `<button onclick="selectTemplate('${tpl.name}')" id="tplbtn-${idx}" title="${tpl.name.replace(/\.html$/i, '')}">${tpl.name.replace(/\.html$/i, '')}</button>`;
      });
      document.getElementById('templatesList').innerHTML = html || 'Нет шаблонов';
    }

    async function selectTemplate(name) {
      try {
        currentTemplateName = name;
        currentTemplateContent = '';
        document.querySelectorAll('#templatesList button').forEach(btn => btn.classList.remove('active'));
        const idx = templatesMeta.findIndex(t => t.name === name);
        if (idx >= 0) document.getElementById(`tplbtn-${idx}`).classList.add('active');
        const rawUrl = templatesMeta[idx].download_url;
        const res = await fetch(rawUrl);
        if (!res.ok) throw new Error('Не удалось загрузить шаблон');
        const text = await res.text();
        currentTemplateContent = text;
        document.getElementById('templateArea').innerHTML = text;
        document.getElementById('finalLetter').innerHTML = '';
        document.getElementById('copyButton').style.display = 'none';
        document.getElementById('errorArea').innerText = '';
      } catch (e) {
        document.getElementById('templateArea').innerText = 'Ошибка загрузки шаблона';
      }
    }

    async function loadGoogleSheet() {
      try {
        const csvUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv`;
        const res = await fetch(csvUrl);
        if (!res.ok) throw new Error('Не удалось загрузить таблицу');
        const csv = await res.text();
        const workbook = XLSX.read(csv, { type: 'string' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        headers = json[0];
        excelData = json.slice(1);
        renderTable();
      } catch (e) {
        document.getElementById('tableArea').innerHTML = 'Ошибка загрузки таблицы';
      }
    }

    function renderTable() {
      let html = `<table class="excel-table"><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += `</tr>`;
      excelData.forEach((row, idx) => {
        html += `<tr onclick="selectRow(${idx})" class="${document.getElementById('rowInput').value - 2 === idx ? 'selected' : ''}">`;
        headers.forEach((h, j) => html += `<td>${row[j] || ''}</td>`);
        html += `</tr>`;
      });
      html += `</table>`;
      document.getElementById('tableArea').innerHTML = html;
    }

    function selectRow(idx) {
      document.getElementById('rowInput').value = idx + 2;
      generateLetter();
    }

    function generateLetter() {
      const errorArea = document.getElementById('errorArea');
      errorArea.innerText = '';
      if (!currentTemplateContent) {
        errorArea.innerText = 'Выберите шаблон письма';
        return;
      }
      const rowNum = parseInt(document.getElementById('rowInput').value);
      if (isNaN(rowNum) || rowNum < 2 || rowNum - 2 >= excelData.length) {
        errorArea.innerText = 'Введите корректный номер строки';
        return;
      }
      const row = excelData[rowNum - 2];
      let letter = currentTemplateContent;
      headers.forEach((h, j) => {
        const regex = new RegExp(`{${h}}`, 'g');
        letter = letter.replace(regex, row[j] || '');
      });
      document.getElementById('finalLetter').innerHTML = letter;
      document.getElementById('copyButton').style.display = 'block';
      renderTable();
    }

    function copyLetter() {
      const finalLetter = document.getElementById('finalLetter');
      const range = document.createRange();
      range.selectNodeContents(finalLetter);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand('copy');
      selection.removeAllRanges();
      const copyButton = document.getElementById('copyButton');
      copyButton.innerText = 'Скопировано!';
      setTimeout(() => { copyButton.innerText = 'Копировать письмо'; }, 2000);
    }

    // Автоматическое обновление реестра каждые 5 минут
    setInterval(loadGoogleSheet, 5 * 60 * 1000);

    fetchTemplatesList();
    loadGoogleSheet();
  </script>
</body>
</html>