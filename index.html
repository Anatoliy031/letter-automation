<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Автоматизация писем (.docx + Google Sheets)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- UI-шрифты (не влияют на .docx) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Парсер CSV Google Sheets -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- DocxTemplater + PizZip для подстановки в .docx -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.38.0/build/docxtemplater.js"></script>

  <!-- Превью .docx как HTML -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root {
      --primary: #1a73e8;
      --sidebar-bg: #1a2a44;
      --border: #e0e7ff;
      --text: #202124;
      --bg-light: #f8f9fa;
      --hover: #e8f0fe;
      --error: #d32f2f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text); line-height: 1.5; }
    #container { display: flex; min-height: 100vh; }
    #sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      color: #fff;
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    #sidebar h3 { font-size: 18px; margin-bottom: 12px; font-weight: 600; }
    #sidebar .note { font-size: 12px; opacity: .85; margin-bottom: 10px; }
    #sidebar button {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      background: #334466;
      border: none;
      color: #fff;
      font-size: 15px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }
    #sidebar button:hover { background: #405080; }
    #sidebar button.active { background: var(--primary); font-weight: 500; }

    #right { flex: 1; padding: 20px; background: #fff; overflow-y: auto; }
    #right h3 { font-size: 18px; margin: 12px 0; font-weight: 600; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 1000px) { .row { grid-template-columns: 1fr; } }

    .excel-table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; }
    .excel-table th, .excel-table td {
      border: 1px solid var(--border); padding: 8px 10px; text-align: left;
    }
    .excel-table th { background: #f1f3f5; font-weight: 500; position: sticky; top: 0; z-index: 1; }
    .excel-table tr:hover { background: var(--hover); cursor: pointer; }
    .excel-table tr.selected { background: #d1e7ff; }
    #tableWrap { max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 6px; }

    .card {
      border: 1px solid var(--border); border-radius: 8px; background: #fff; padding: 12px;
    }
    .controls { display: grid; grid-template-columns: 1fr 200px 170px; gap: 10px; align-items: center; margin: 8px 0 4px; }
    @media (max-width: 700px) { .controls { grid-template-columns: 1fr; } }

    input[type="number"], input[type="text"] {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;
    }
    .btn-primary, .btn-secondary {
      width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; transition: .2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #1557b0; }
    .btn-secondary { background: #efefef; }
    .btn-secondary:hover { background: #e2e2e2; }

    .error { color: var(--error); font-size: 14px; margin: 6px 0; }
    .muted { font-size: 12px; opacity: .85; }
    #preview { min-height: 220px; border: 1px solid var(--border); border-radius: 6px; padding: 12px; background: var(--bg-light); overflow: auto; }
  </style>
</head>
<body>
  <div id="container">
    <aside id="sidebar">
      <h3>Шаблоны (.docx)</h3>
      <div class="note">Теги вида <code>{{Поле}}</code>. Шрифты/отступы — как в Word.</div>
      <div id="templatesList">Загрузка…</div>
    </aside>

    <main id="right">
      <div class="row">
        <section class="card">
          <h3>Реестр (Google Sheets)</h3>
          <div class="controls">
            <input type="text" id="sheetIdInput" placeholder="ID Google-таблицы">
            <input type="number" id="rowInput" placeholder="№ строки (со 2)" min="2">
            <button class="btn-secondary" id="reloadSheetBtn">Обновить</button>
          </div>
          <div id="tableWrap"></div>
          <div id="errorTable" class="error"></div>
          <div class="muted">Клик по строке — подставит её номер.</div>
        </section>

        <section class="card">
          <h3>Форма письма (превью)</h3>
          <div id="preview">Выберите шаблон и строку реестра.</div>
          <div id="errorTpl" class="error"></div>
          <div class="controls" style="grid-template-columns: 1fr 1fr;">
            <button class="btn-primary" id="generateBtn">Сформировать превью</button>
            <button class="btn-secondary" id="downloadBtn" disabled>Скачать .docx</button>
          </div>
          <div class="muted">Превью — текст и базовая разметка. Итоговый .docx — 1:1 как шаблон (шрифты, отступы, поля).</div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ====== НАСТРОЙКИ ======
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";

    // НОВЫЙ ID Google-таблицы
    const DEFAULT_GOOGLE_SHEET_ID = "17vdbh0KHIZ-lAsqFXp6HtQA-NBymV5Wh";

    // ====== СОСТОЯНИЕ ======
    let templatesMeta = [];
    let selectedTemplate = null;
    let excelHeaders = [];
    let excelRows = [];
    let lastGeneratedBlob = null;

    // ====== UI ======
    const $tplList = document.getElementById('templatesList');
    const $tableWrap = document.getElementById('tableWrap');
    const $rowInput = document.getElementById('rowInput');
    const $sheetIdInput = document.getElementById('sheetIdInput');
    const $reloadSheetBtn = document.getElementById('reloadSheetBtn');
    const $preview = document.getElementById('preview');
    const $errorTpl = document.getElementById('errorTpl');
    const $errorTable = document.getElementById('errorTable');
    const $generateBtn = document.getElementById('generateBtn');
    const $downloadBtn = document.getElementById('downloadBtn');

    // ====== HELPERS ======
    function setError(el, msg) { el.textContent = msg || ""; }
    function clearPreview() { $preview.innerHTML = "Выберите шаблон и строку реестра."; }
    function csvUrlFromSheetId(id) {
      return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
    }
    function makeDataObject(headers, row) {
      const obj = {};
      headers.forEach((h, i) => { obj[h] = row[i] ?? ""; });
      return obj;
    }

    // ====== ШАБЛОНЫ (.docx) ИЗ GITHUB ======
    async function fetchTemplatesList() {
      try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("GitHub API error");
        const files = await res.json();
        templatesMeta = files.filter(f => /\.docx$/i.test(f.name));
        renderTemplatesList();
      } catch (e) {
        $tplList.innerHTML = "Ошибка загрузки шаблонов";
      }
    }

    function renderTemplatesList() {
      if (!templatesMeta.length) {
        $tplList.innerHTML = "Нет .docx-шаблонов в /templates";
        return;
      }
      $tplList.innerHTML = templatesMeta.map((t, idx) =>
        `<button id="tplbtn-${idx}" onclick="selectTemplate(${idx})" title="${t.name.replace(/\.docx$/i,'')}">${t.name.replace(/\.docx$/i,'')}</button>`
      ).join("");
    }

    window.selectTemplate = function(idx) {
      document.querySelectorAll('#templatesList button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById(`tplbtn-${idx}`);
      if (btn) btn.classList.add('active');
      selectedTemplate = templatesMeta[idx];
      setError($errorTpl, "");
      clearPreview();
      $downloadBtn.disabled = true;
      lastGeneratedBlob = null;
    }

    // ====== GOOGLE SHEETS (CSV) ======
    async function loadGoogleSheet(sheetId) {
      try {
        setError($errorTable, "");
        const res = await fetch(csvUrlFromSheetId(sheetId));
        if (!res.ok) throw new Error("Не удалось загрузить таблицу (проверьте доступ по ссылке)");
        const csv = await res.text();
        const wb = XLSX.read(csv, { type: 'string' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (!json.length) throw new Error("Пустая таблица");
        excelHeaders = json[0];
        excelRows = json.slice(1);
        renderTable();
      } catch (e) {
        $tableWrap.innerHTML = "";
        setError($errorTable, e.message || "Ошибка загрузки таблицы");
      }
    }

    function renderTable() {
      if (!excelHeaders.length) { $tableWrap.innerHTML = ""; return; }
      let html = `<table class="excel-table"><thead><tr>`;
      excelHeaders.forEach(h => html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      excelRows.forEach((row, i) => {
        html += `<tr onclick="pickRow(${i})" class="${(parseInt($rowInput.value)-2===i)?'selected':''}">`;
        excelHeaders.forEach((h, j) => html += `<td>${row[j] ?? ''}</td>`);
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      $tableWrap.innerHTML = html;
    }

    window.pickRow = function(i) {
      $rowInput.value = i + 2;
      renderTable();
    }

    // ====== ГЕНЕРАЦИЯ DOCX + PREVIEW ======
    async function fetchArrayBuffer(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Не удалось загрузить шаблон");
      return await res.arrayBuffer();
    }

    async function generateDocxAndPreview() {
      setError($errorTpl, "");
      $downloadBtn.disabled = true;
      lastGeneratedBlob = null;

      if (!selectedTemplate) {
        setError($errorTpl, "Выберите шаблон (.docx) слева");
        return;
      }
      const rowNum = parseInt($rowInput.value);
      if (isNaN(rowNum) || rowNum < 2 || rowNum - 2 >= excelRows.length) {
        setError($errorTpl, "Введите корректный номер строки реестра");
        return;
      }

      try {
        const ab = await fetchArrayBuffer(selectedTemplate.download_url);
        const zip = new PizZip(ab);

        const doc = new window.docxtemplater().loadZip(zip);
        const data = makeDataObject(excelHeaders, excelRows[rowNum - 2]);
        doc.setData(data);
        doc.render();

        const out = doc.getZip().generate({ type: "blob" });
        lastGeneratedBlob = out;

        const arrayBuffer = await out.arrayBuffer();
        const result = await window.mammoth.convertToHtml({ arrayBuffer });
        $preview.innerHTML = result.value;
        $downloadBtn.disabled = false;
      } catch (e) {
        console.error(e);
        setError($errorTpl, "Ошибка формирования. Проверьте совпадение тегов {{...}} и заголовков столбцов.");
      }
    }

    function downloadDocx() {
      if (!lastGeneratedBlob || !selectedTemplate) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(lastGeneratedBlob);
      a.href = url;
      const cleanName = selectedTemplate.name.replace(/\.docx$/i, '');
      const rowNum = parseInt($rowInput.value) || 'X';
      a.download = `${cleanName}_${rowNum}.docx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== СВЯЗКА UI ======
    $sheetIdInput.value = DEFAULT_GOOGLE_SHEET_ID;
    $reloadSheetBtn.addEventListener('click', () => loadGoogleSheet($sheetIdInput.value.trim()));
    $generateBtn.addEventListener('click', generateDocxAndPreview);
    $downloadBtn.addEventListener('click', downloadDocx);

    // Автообновление каждые 5 минут
    setInterval(() => {
      const id = $sheetIdInput.value.trim();
      if (id) loadGoogleSheet(id);
    }, 5 * 60 * 1000);

    // Первичная загрузка
    fetchTemplatesList();
    loadGoogleSheet(DEFAULT_GOOGLE_SHEET_ID);
  </script>
</body>
</html>
