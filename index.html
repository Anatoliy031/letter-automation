<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Автоматизация писем</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/docx@9.0.1/build/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a73e8;
      --sidebar-bg: #1a2a44;
      --border: #e0e7ff;
      --text: #202124;
      --bg-light: #f8f9fa;
      --hover: #e8f0fe;
      --error: #d32f2f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text); line-height: 1.5; }
    #container { display: flex; min-height: 100vh; }
    #sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: #fff;
      padding: 15px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    #sidebar.hidden { transform: translateX(-100%); }
    #sidebar h3 { font-size: 16px; margin-bottom: 10px; font-weight: 600; }
    #sidebar button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      background: #334466;
      border: none;
      color: #fff;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: background 0.2s;
    }
    #sidebar button:hover { background: #405080; }
    #sidebar button.active { background: var(--primary); font-weight: 500; }
    #toggleSidebar {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 20;
      font-size: 14px;
    }
    #main { display: none; }
    #right {
      flex: 1;
      padding: 15px;
      background: #fff;
      overflow-y: auto;
    }
    #right h3 { font-size: 16px; margin-bottom: 10px; font-weight: 600; }
    #searchInput {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 13px;
    }
    .excel-table th, .excel-table td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }
    .excel-table th { background: #f1f3f5; font-weight: 500; }
    .excel-table tr:hover { background: var(--hover); cursor: pointer; }
    .excel-table tr.selected { background: #d1e7ff; }
    #tableArea { max-height: 250px; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; }
    #templateArea {
      min-height: 150px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 13px;
      overflow-x: auto;
    }
    #rowInput {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 10px;
    }
    #generateButton, #copyButton, #downloadWordButton {
      width: 100%;
      padding: 10px;
      background: var(--primary);
      border: none;
      color: #fff;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    #generateButton:hover, #copyButton:hover, #downloadWordButton:hover { background: #1557b0; }
    #finalLetter {
      min-height: 150px;
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      overflow-x: auto;
    }
    .letter-html table { border-collapse: collapse; }
    .letter-html th, .letter-html td { border: 1px solid var(--border); padding: 5px 8px; }
    .error { color: var(--error); font-size: 13px; margin-bottom: 10px; }
    @media (max-width: 900px) {
      #container { flex-direction: column; }
      #sidebar {
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 10;
        transform: translateX(-100%);
      }
      #sidebar.visible { transform: translateX(0); }
      #toggleSidebar { display: block; }
      #right { width: 100%; padding: 10px; }
      #tableArea { max-height: 200px; }
      #templateArea, #finalLetter { min-height: 120px; }
    }
  </style>
</head>
<body>
  <button id="toggleSidebar" onclick="toggleSidebar()">☰ Шаблоны</button>
  <div id="container">
    <div id="sidebar" class="hidden">
      <h3>Шаблоны писем</h3>
      <div id="templatesList">Загрузка...</div>
    </div>
    <div id="main"></div>
    <div id="right">
      <h3>Реестр заявок</h3>
      <input type="text" id="searchInput" placeholder="Поиск по реестру..." oninput="searchTable()">
      <div id="tableArea"></div>
      <h3>Форма письма</h3>
      <div id="templateArea" class="letter-html">Выберите шаблон письма и строку из реестра.</div>
      <input type="number" id="rowInput" placeholder="Введите номер строки реестра" min="2">
      <button id="generateButton" onclick="generateLetter()">Сформировать письмо</button>
      <div id="errorArea" class="error"></div>
      <h3>Итоговое письмо</h3>
      <button id="copyButton" onclick="copyLetter()" style="display: none;">Копировать письмо</button>
      <button id="downloadWordButton" onclick="downloadWord()" style="display: none;">Скачать письмо (Word)</button>
      <div id="finalLetter" class="letter-html"></div>
    </div>
  </div>
  <script>
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";
    const GOOGLE_SHEET_ID = "1-P3T-ik_gU7qrr0KGDFbxQ80F70_Z8K5QT4siN31Or4";

    let templatesMeta = [];
    let currentTemplateName = '';
    let currentTemplateContent = '';
    let excelData = [];
    let headers = [];
    let filteredData = [];

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('visible');
      sidebar.classList.toggle('hidden');
    }

    async function fetchTemplatesList() {
      try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('Не удалось загрузить шаблоны');
        const files = await res.json();
        templatesMeta = files.filter(f => /\.html$/i.test(f.name));
        renderTemplatesList();
      } catch (e) {
        document.getElementById('templatesList').innerHTML = 'Ошибка загрузки шаблонов';
      }
    }

    function renderTemplatesList() {
      let html = '';
      templatesMeta.forEach((tpl, idx) => {
        html += `<button onclick="selectTemplate('${tpl.name}'); toggleSidebar();" id="tplbtn-${idx}" title="${tpl.name.replace(/\.html$/i, '')}">${tpl.name.replace(/\.html$/i, '')}</button>`;
      });
      document.getElementById('templatesList').innerHTML = html || 'Нет шаблонов';
    }

    async function selectTemplate(name) {
      try {
        currentTemplateName = name;
        currentTemplateContent = '';
        document.querySelectorAll('#templatesList button').forEach(btn => btn.classList.remove('active'));
        const idx = templatesMeta.findIndex(t => t.name === name);
        if (idx >= 0) document.getElementById(`tplbtn-${idx}`).classList.add('active');
        const rawUrl = templatesMeta[idx].download_url;
        const res = await fetch(rawUrl);
        if (!res.ok) throw new Error('Не удалось загрузить шаблон');
        const text = await res.text();
        currentTemplateContent = text;
        document.getElementById('templateArea').innerHTML = text;
        document.getElementById('finalLetter').innerHTML = '';
        document.getElementById('copyButton').style.display = 'none';
        document.getElementById('downloadWordButton').style.display = 'none';
        document.getElementById('errorArea').innerText = '';
      } catch (e) {
        document.getElementById('templateArea').innerText = 'Ошибка загрузки шаблона';
      }
    }

    async function loadGoogleSheet() {
      try {
        const csvUrl = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/export?format=csv`;
        const res = await fetch(csvUrl);
        if (!res.ok) throw new Error('Не удалось загрузить таблицу');
        const csv = await res.text();
        const workbook = XLSX.read(csv, { type: 'string' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        headers = json[0];
        excelData = json.slice(1);
        filteredData = [...excelData];
        renderTable();
      } catch (e) {
        document.getElementById('tableArea').innerHTML = 'Ошибка загрузки таблицы';
      }
    }

    function searchTable() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      filteredData = excelData.filter(row =>
        row.some(cell => (cell || '').toString().toLowerCase().includes(searchInput))
      );
      renderTable();
    }

    function renderTable() {
      let html = `<table class="excel-table"><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += `</tr>`;
      if (filteredData.length === 0) {
        html += `<tr><td colspan="${headers.length}" style="text-align: center;">Нет результатов</td></tr>`;
      } else {
        filteredData.forEach((row, idx) => {
          const originalIdx = excelData.indexOf(row);
          html += `<tr onclick="selectRow(${originalIdx})" class="${document.getElementById('rowInput').value - 2 === originalIdx ? 'selected' : ''}">`;
          headers.forEach((h, j) => html += `<td>${row[j] || ''}</td>`);
          html += `</tr>`;
        });
      }
      html += `</table>`;
      document.getElementById('tableArea').innerHTML = html;
    }

    function selectRow(idx) {
      document.getElementById('rowInput').value = idx + 2;
      generateLetter();
    }

    function generateLetter() {
      const errorArea = document.getElementById('errorArea');
      errorArea.innerText = '';
      if (!currentTemplateContent) {
        errorArea.innerText = 'Выберите шаблон письма';
        return;
      }
      const rowNum = parseInt(document.getElementById('rowInput').value);
      if (isNaN(rowNum) || rowNum < 2 || rowNum - 2 >= excelData.length) {
        errorArea.innerText = 'Введите корректный номер строки';
        return;
      }
      const row = excelData[rowNum - 2];
      let letter = currentTemplateContent;
      headers.forEach((h, j) => {
        const regex = new RegExp(`{${h}}`, 'g');
        letter = letter.replace(regex, row[j] || '');
      });
      document.getElementById('finalLetter').innerHTML = letter;
      document.getElementById('copyButton').style.display = 'block';
      document.getElementById('downloadWordButton').style.display = 'block';
      renderTable();
    }

    function copyLetter() {
      const finalLetter = document.getElementById('finalLetter');
      const range = document.createRange();
      range.selectNodeContents(finalLetter);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      document.execCommand('copy');
      selection.removeAllRanges();
      const copyButton = document.getElementById('copyButton');
      copyButton.innerText = 'Скопировано!';
      setTimeout(() => { copyButton.innerText = 'Копировать письмо'; }, 2000);
    }

    function downloadWord() {
      const finalLetter = document.getElementById('finalLetter');
      const doc = new docx.Document({
        sections: [{
          properties: {},
          children: parseHtmlToDocx(finalLetter)
        }]
      });
      docx.Packer.toBlob(doc).then(blob => {
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
        saveAs(blob, `Letter_${timestamp}.docx`);
      });
    }

    function parseHtmlToDocx(element) {
      const children = [];
      for (const node of element.childNodes) {
        if (node.nodeType === Node.TEXT_NODE) {
          children.push(new docx.Paragraph({
            children: [new docx.TextRun(node.textContent.trim())],
            spacing: { after: 200 }
          }));
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          if (node.tagName === 'P') {
            children.push(new docx.Paragraph({
              children: [new docx.TextRun(node.textContent.trim())],
              spacing: { after: 200 }
            }));
          } else if (node.tagName === 'TABLE') {
            const rows = [];
            const trs = node.querySelectorAll('tr');
            trs.forEach(tr => {
              const cells = [];
              const tds = tr.querySelectorAll('td, th');
              tds.forEach(td => {
                cells.push(new docx.TableCell({
                  children: [new docx.Paragraph({
                    children: [new docx.TextRun(td.textContent.trim())]
                  })]
                }));
              });
              rows.push(new docx.TableRow({ children: cells }));
            });
            children.push(new docx.Table({ rows }));
          } else if (['UL', 'OL'].includes(node.tagName)) {
            node.querySelectorAll('li').forEach(li => {
              children.push(new docx.Paragraph({
                children: [new docx.TextRun(`• ${li.textContent.trim()}`)],
                bullet: { level: 0 },
                spacing: { after: 100 }
              }));
            });
          } else {
            children.push(...parseHtmlToDocx(node));
          }
        }
      }
      return children;
    }

    // Инициализация: скрыть боковую панель на мобильных устройствах
    if (window.innerWidth <= 900) {
      document.getElementById('sidebar').classList.add('hidden');
      document.getElementById('toggleSidebar').style.display = 'block';
    }

    // Обработчик изменения размера окна
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 900) {
        document.getElementById('sidebar').classList.add('hidden');
        document.getElementById('toggleSidebar').style.display = 'block';
      } else {
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('toggleSidebar').style.display = 'none';
      }
    });

    // Автоматическое обновление реестра каждые 5 минут
    setInterval(loadGoogleSheet, 5 * 60 * 1000);

    fetchTemplatesList();
    loadGoogleSheet();
  </script>
</body>
</html>
