<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автоматизация писем — адаптивная версия ([[...]] теги)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- UI-шрифт (на .docx не влияет) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- CSV / Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- DocxTemplater + PizZip -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.38.0/build/docxtemplater.js"></script>

  <!-- Mammoth: превью .docx как HTML -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root{
      --primary:#1a73e8;--sidebar-bg:#1a2a44;--border:#e0e7ff;--text:#202124;--bg:#fff;--bg-light:#f7f9fc;
      --hover:#e8f0fe;--error:#d32f2f;--ok:#188038;--shadow:0 6px 24px rgba(0,0,0,.06)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg-light)}

    /* Top App Bar */
    .appbar{
      position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;padding:10px 12px
    }
    .app-title{font-weight:600}
    .spacer{flex:1}
    .icon-btn{
      appearance:none;border:0;background:transparent;cursor:pointer;padding:8px;border-radius:10px
    }
    .icon-btn:hover{background:#f1f5ff}
    .ham{width:24px;height:2px;background:#222;position:relative;display:block}
    .ham::before,.ham::after{content:"";position:absolute;left:0;right:0;height:2px;background:#222}
    .ham::before{top:-7px}.ham::after{top:7px}

    /* Layout */
    .layout{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 54px)}
    /* Sidebar (desktop/tablet) */
    aside#sidebar{
      background:var(--sidebar-bg);color:#fff;padding:16px;border-right:1px solid rgba(255,255,255,.08);
      overflow:auto
    }
    .sb-title{font-size:16px;font-weight:600;margin-bottom:10px}
    .sb-note{font-size:12px;opacity:.9;margin-bottom:10px}
    .sb-search{display:flex;gap:8px;margin-bottom:10px}
    .sb-search input{
      width:100%;padding:9px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff
    }
    .tpl-list{display:grid;gap:6px}
    .tpl-btn{
      width:100%;text-align:left;background:#334466;color:#fff;border:0;border-radius:8px;padding:10px;
      cursor:pointer;transition:.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .tpl-btn:hover{background:#3b4e78}
    .tpl-btn.active{background:var(--primary);font-weight:600}

    /* Main */
    main{padding:16px;overflow:auto}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:16px
    }
    .card{
      background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)
    }
    h3{margin:8px 0 12px;font-size:16px}
    .controls{display:grid;grid-template-columns:1fr 160px 140px;gap:8px;align-items:center;margin-bottom:8px}
    .controls input{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:14px
    }
    .btn{border:0;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#eef1f7}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .excel-wrap{border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:45vh;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#f4f6fb;z-index:1}
    tbody tr:hover{background:var(--hover);cursor:pointer}
    .selected{background:#d7e6ff}
    .error{color:var(--error);font-size:13px;margin-top:6px;white-space:pre-wrap}
    .muted{font-size:12px;opacity:.8}

    #preview{min-height:200px;border:1px solid var(--border);border-radius:10px;background:#fafbff;padding:12px;overflow:auto}

    .diag{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .listbox{background:#f7f9ff;border:1px dashed var(--border);padding:8px;border-radius:10px;font-size:12px}
    code.k{background:#eee;border-radius:6px;padding:2px 6px;margin:2px 4px 0 0;display:inline-block}

    /* Drawer (mobile) */
    .drawer{
      position:fixed;inset:0 30% 0 0;max-width:80vw;background:var(--sidebar-bg);color:#fff;padding:14px;
      transform:translateX(-100%);transition:transform .2s ease;z-index:60;overflow:auto;border-right:1px solid rgba(255,255,255,.08)
    }
    .drawer.open{transform:none}
    .scrim{
      position:fixed;inset:0;background:rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.2s;z-index:55
    }
    .scrim.show{opacity:1;pointer-events:auto}

    /* Responsive */
    @media (max-width:1199px){
      .layout{grid-template-columns:260px 1fr}
      .grid{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr 1fr}
    }
    @media (max-width:767px){
      .layout{display:block} /* sidebar -> drawer */
      aside#sidebar{display:none}
      .grid{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr}
      .excel-wrap{max-height:50vh}
      .tpl-list{grid-template-columns:1fr} /* компактный список */
    }
  </style>
</head>
<body>
  <!-- App bar -->
  <div class="appbar">
    <button id="menuBtn" class="icon-btn" aria-label="Открыть меню">
      <span class="ham"></span>
    </button>
    <div class="app-title">Автоматизация писем</div>
    <div class="spacer"></div>
    <!-- можно добавить кнопку "Помощь" / "Справка" при необходимости -->
  </div>

  <!-- Drawer for mobile -->
  <div id="scrim" class="scrim" aria-hidden="true"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="sb-title">Шаблоны (.docx)</div>
    <div class="sb-note">Теги <code>[[Поле]]</code>. Шрифты/отступы — как в Word.</div>
    <div class="sb-search">
      <input id="tplSearchMobile" placeholder="Поиск шаблона...">
    </div>
    <div id="tplListMobile" class="tpl-list">Загрузка…</div>
  </aside>

  <div class="layout">
    <!-- Sidebar for tablet/desktop -->
    <aside id="sidebar">
      <div class="sb-title">Шаблоны (.docx)</div>
      <div class="sb-note">Теги <code>[[Поле]]</code>. Шрифты/отступы — как в Word.</div>
      <div class="sb-search">
        <input id="tplSearch" placeholder="Поиск шаблона...">
      </div>
      <div id="templatesList" class="tpl-list">Загрузка…</div>
    </aside>

    <main>
      <div class="grid">
        <section class="card">
          <h3>Реестр (Google Sheets)</h3>
          <div class="controls">
            <input type="text" id="sheetIdInput" placeholder="ID Google-таблицы">
            <input type="number" id="rowInput" placeholder="№ строки (со 2)" min="2">
            <button class="btn btn-secondary" id="reloadSheetBtn">Обновить</button>
          </div>
          <div class="excel-wrap" id="tableWrap"></div>
          <div id="errorTable" class="error"></div>
          <div class="muted">Клик по строке — подставит её номер.</div>
        </section>

        <section class="card">
          <h3>Форма письма</h3>
          <div id="preview">Выберите шаблон и строку реестра.</div>
          <div id="errorTpl" class="error"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <button class="btn btn-primary" id="generateBtn">Сформировать превью</button>
            <button class="btn btn-secondary" id="downloadBtn" disabled>Скачать .docx</button>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin-top:0">Диагностика соответствия</h3>
            <div class="diag">
              <div>
                <div class="muted">Теги в выбранном шаблоне</div>
                <div id="tplTags" class="listbox">—</div>
              </div>
              <div>
                <div class="muted">Заголовки в таблице</div>
                <div id="sheetHeaders" class="listbox">—</div>
              </div>
            </div>
            <div class="diag" style="margin-top:8px">
              <div>
                <div class="muted">Отсутствуют в таблице</div>
                <div id="missingInSheet" class="listbox">—</div>
              </div>
              <div>
                <div class="muted">Лишние столбцы</div>
                <div id="unusedHeaders" class="listbox">—</div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== НАСТРОЙКИ =====
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";
    const DEFAULT_GOOGLE_SHEET_ID = "17vdbh0KHIZ-lAsqFXp6HtQA-NBymV5Wh";

    // ===== СОСТОЯНИЕ =====
    let templatesMeta = [];
    let selectedTemplate = null;
    let excelHeaders = [];
    let excelRows = [];
    let lastGeneratedBlob = null;
    let currentTplTags = [];
    let filterQuery = "";

    // ===== UI =====
    const $sidebarList = document.getElementById('templatesList');
    const $tplListMobile = document.getElementById('tplListMobile');
    const $tplSearch = document.getElementById('tplSearch');
    const $tplSearchMobile = document.getElementById('tplSearchMobile');

    const $tableWrap = document.getElementById('tableWrap');
    const $rowInput = document.getElementById('rowInput');
    const $sheetIdInput = document.getElementById('sheetIdInput');
    const $reloadSheetBtn = document.getElementById('reloadSheetBtn');
    const $preview = document.getElementById('preview');
    const $errorTpl = document.getElementById('errorTpl');
    const $errorTable = document.getElementById('errorTable');
    const $generateBtn = document.getElementById('generateBtn');
    const $downloadBtn = document.getElementById('downloadBtn');

    const $tplTags = document.getElementById('tplTags');
    const $sheetHeaders = document.getElementById('sheetHeaders');
    const $missingInSheet = document.getElementById('missingInSheet');
    const $unusedHeaders = document.getElementById('unusedHeaders');

    // Drawer elements
    const $menuBtn = document.getElementById('menuBtn');
    const $drawer = document.getElementById('drawer');
    const $scrim = document.getElementById('scrim');

    // ===== HELPERS =====
    const isMobile = () => window.matchMedia("(max-width: 767px)").matches;
    function setError(el, msg){ el.textContent = msg || ""; if(msg){ setTimeout(()=>{ if(el.textContent===msg) el.textContent=""; }, 4000); } }
    function clearPreview(){ $preview.innerHTML = "Выберите шаблон и строку реестра."; }
    function csvUrlFromSheetId(id){ return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`; }
    function uniq(arr){ return [...new Set(arr)]; }
    function renderKeysBox(el, list){ el.innerHTML = (!list || !list.length) ? "—" : list.map(k=>`<code class="k">${k}</code>`).join(" "); }
    function normalizeKey(s){
      if(!s) return "";
      return s.normalize("NFC").replace(/\u00A0/g,' ').replace(/№/g,'N').replace(/[.,;:()]/g,'').replace(/\s+/g,'_').replace(/-+/g,'_').replace(/__+/g,'_').trim();
    }
    function makeAliases(header){
      const h = header ?? "";
      const withUnderscore = h.replace(/\s+/g,'_');
      const withSpaces = h.replace(/_/g,' ');
      const norm = normalizeKey(h);
      return uniq([h, withUnderscore, withSpaces, h.toLowerCase(), withUnderscore.toLowerCase(), withSpaces.toLowerCase(), norm, norm.toLowerCase()]);
    }
    function buildDataObject(headers,row){
      const obj={};
      headers.forEach((h,i)=>{ (makeAliases(h)).forEach(alias=>obj[alias] = row[i] ?? ""); });
      return obj;
    }
    function filterByQuery(name){
      return !filterQuery || name.toLowerCase().includes(filterQuery.toLowerCase());
    }

    // ===== DRAWER =====
    function openDrawer(){ $drawer.classList.add('open'); $drawer.setAttribute('aria-hidden','false'); $scrim.classList.add('show'); $scrim.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ $drawer.classList.remove('open'); $drawer.setAttribute('aria-hidden','true'); $scrim.classList.remove('show'); $scrim.setAttribute('aria-hidden','true'); }
    $menuBtn.addEventListener('click', openDrawer);
    $scrim.addEventListener('click', closeDrawer);
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDrawer(); });

    // ===== ЗАГРУЗКА ШАБЛОНОВ =====
    async function fetchTemplatesList(){
      try{
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if(!res.ok) throw new Error("GitHub API error");
        const files = await res.json();
        templatesMeta = files.filter(f=>/\.docx$/i.test(f.name)).map(f=>({name:f.name, url:f.download_url}));
        renderTemplatesLists();
      }catch(e){
        $sidebarList.innerHTML = "Ошибка загрузки шаблонов";
        $tplListMobile.innerHTML = "Ошибка загрузки шаблонов";
      }
    }
    function renderTemplatesLists(){
      const render = (container)=>{
        if(!templatesMeta.length){ container.innerHTML = "Нет .docx-шаблонов в /templates"; return; }
        container.innerHTML = templatesMeta
          .filter(t=>filterByQuery(t.name.replace(/\.docx$/i,'')))
          .map((t,idx)=>`<button class="tpl-btn ${selectedTemplate && selectedTemplate.name===t.name?'active':''}" onclick="selectTemplate(${idx}, ${container.id==='tplListMobile'})" title="${t.name.replace(/\.docx$/i,'')}">${t.name.replace(/\.docx$/i,'')}</button>`)
          .join("");
      };
      render($sidebarList);
      render($tplListMobile);
    }
    window.selectTemplate = async function(idx, fromMobile=false){
      selectedTemplate = templatesMeta[idx];
      renderTemplatesLists();
      if(fromMobile && isMobile()) closeDrawer();
      setError($errorTpl,"");
      clearPreview();
      $downloadBtn.disabled = true;
      lastGeneratedBlob = null;
      currentTplTags = await extractDocxTags(selectedTemplate.url);
      renderKeysBox($tplTags, currentTplTags);
      updateDiagnostics();
    }

    // Поиск по шаблонам
    function bindSearch(input){
      input.addEventListener('input', ()=>{
        filterQuery = input.value.trim();
        renderTemplatesLists();
      });
    }
    bindSearch($tplSearch);
    bindSearch($tplSearchMobile);

    // ===== ИЗВЛЕЧЕНИЕ ТЕГОВ [[...]] =====
    async function extractDocxTags(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error("Не удалось загрузить шаблон");
        const ab = await res.arrayBuffer();
        const zip = new PizZip(ab);
        const xmlNames = Object.keys(zip.files).filter(n=>n.startsWith('word/') && n.endsWith('.xml'));
        const tagSet = new Set();
        const rgx = /\[\[\s*([^\]]+?)\s*\]\]/g;
        xmlNames.forEach(name=>{
          try{
            const txt = zip.files[name].asText();
            let m; while((m = rgx.exec(txt))!==null){ tagSet.add(m[1].trim().split('|')[0].trim()); }
          }catch(_){}
        });
        return Array.from(tagSet).sort((a,b)=>a.localeCompare(b));
      }catch(e){
        console.warn("extractDocxTags error:", e); return [];
      }
    }

    // ===== GOOGLE SHEETS =====
    async function loadGoogleSheet(sheetId){
      try{
        setError($errorTable,"");
        const res = await fetch(csvUrlFromSheetId(sheetId));
        if(!res.ok) throw new Error("Не удалось загрузить таблицу (проверьте доступ по ссылке)");
        const csv = await res.text();
        const wb = XLSX.read(csv,{type:'string'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws,{header:1});
        if(!json.length) throw new Error("Пустая таблица");
        excelHeaders = json[0].map(h => (h ?? "").toString().trim());
        excelRows = json.slice(1);
        renderTable();
        renderKeysBox($sheetHeaders, excelHeaders);
        updateDiagnostics();
      }catch(e){
        $tableWrap.innerHTML = "";
        renderKeysBox($sheetHeaders, []);
        setError($errorTable, e.message || "Ошибка загрузки таблицы");
        updateDiagnostics();
      }
    }

    function renderTable(){
      if(!excelHeaders.length){ $tableWrap.innerHTML=""; return; }
      let html = `<table><thead><tr>`;
      excelHeaders.forEach(h=> html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      excelRows.forEach((row,i)=>{
        html += `<tr onclick="pickRow(${i})" class="${(parseInt($rowInput.value)-2===i)?'selected':''}">`;
        excelHeaders.forEach((h,j)=> html += `<td>${row[j] ?? ''}</td>`);
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      $tableWrap.innerHTML = `<div class="excel-wrap-inner">${html}</div>`;
    }
    window.pickRow = function(i){
      $rowInput.value = i + 2; renderTable();
      // автоскролл превью в начало
      $preview.scrollTop = 0;
    }

    // ===== ДИАГНОСТИКА =====
    function updateDiagnostics(){
      const hdrAliases = new Map();
      excelHeaders.forEach(h => makeAliases(h).forEach(a => hdrAliases.set(a,h)));
      const missing = [];
      const used = new Set();
      currentTplTags.forEach(tag=>{
        const cands = uniq([tag, tag.toLowerCase(), normalizeKey(tag), normalizeKey(tag).toLowerCase(), tag.replace(/\s+/g,'_'), tag.replace(/_/g,' ')]);
        let matched = null;
        for(const c of cands){ if(hdrAliases.has(c)){ matched = hdrAliases.get(c); break; } }
        if(!matched) missing.push(tag); else used.add(matched);
      });
      const unused = excelHeaders.filter(h=>!used.has(h));
      renderKeysBox($missingInSheet, missing);
      renderKeysBox($unusedHeaders, unused);
    }

    // ===== ГЕНЕРАЦИЯ DOCX + PREVIEW =====
    async function generateDocxAndPreview(){
      setError($errorTpl,""); $downloadBtn.disabled = true; lastGeneratedBlob = null;
      if(!selectedTemplate){ setError($errorTpl,"Выберите шаблон (.docx)"); return; }
      const rowNum = parseInt($rowInput.value);
      if(isNaN(rowNum)||rowNum<2||rowNum-2>=excelRows.length){ setError($errorTpl,"Введите корректный номер строки"); return; }

      try{
        const res = await fetch(selectedTemplate.url);
        if(!res.ok) throw new Error("Не удалось загрузить шаблон");
        const ab = await res.arrayBuffer();
        const zip = new PizZip(ab);

        const doc = new window.docxtemplater(zip, { delimiters:{start:'[[', end:']]'} });
        const data = buildDataObject(excelHeaders, excelRows[rowNum-2]);
        doc.setData(data);

        try{ doc.render(); }
        catch(e){
          let details = "";
          if(e.properties?.errors){
            details = e.properties.errors.map(err => `• ${err.properties?.explanation || err.properties?.id || err.message || "Ошибка"}`).join("\n");
          }
          throw new Error("Ошибка формирования шаблона.\n" + details + "\nПроверьте совпадение тегов и заголовков (см. «Диагностика соответствия»).");
        }

        const out = doc.getZip().generate({ type:"blob" });
        lastGeneratedBlob = out;

        const buf = await out.arrayBuffer();
        const result = await window.mammoth.convertToHtml({ arrayBuffer:buf });
        $preview.innerHTML = result.value || "<i>(Превью пустое — но .docx сформирован)</i>";
        $downloadBtn.disabled = false;

        // лёгкий автоскролл к превью на мобильных
        if(isMobile()){ document.querySelector('#preview').scrollIntoView({behavior:'smooth', block:'start'}); }
      }catch(e){
        console.error(e); setError($errorTpl, e.message || "Ошибка формирования");
      }
    }
    function downloadDocx(){
      if(!lastGeneratedBlob || !selectedTemplate) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(lastGeneratedBlob);
      a.href = url;
      const clean = selectedTemplate.name.replace(/\.docx$/i,'');
      const rowNum = parseInt($rowInput.value)||'X';
      a.download = `${clean}_${rowNum}.docx`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== СВЯЗКА UI =====
    $sheetIdInput.value = DEFAULT_GOOGLE_SHEET_ID;
    $reloadSheetBtn.addEventListener('click', ()=>loadGoogleSheet($sheetIdInput.value.trim()));
    $generateBtn.addEventListener('click', generateDocxAndPreview);
    $downloadBtn.addEventListener('click', downloadDocx);

    // автообновление таблицы каждые 5 минут
    setInterval(()=>{ const id = $sheetIdInput.value.trim(); if(id) loadGoogleSheet(id); }, 5*60*1000);

    // первичная загрузка
    fetchTemplatesList();
    loadGoogleSheet(DEFAULT_GOOGLE_SHEET_ID);
  </script>
</body>
</html>
