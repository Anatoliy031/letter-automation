<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автоматизация писем (.docx + Google Sheets) — теги [[...]]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- UI-шрифт (на итоговый .docx не влияет) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- CSV / Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- DocxTemplater + PizZip -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.38.0/build/docxtemplater.js"></script>

  <!-- Mammoth: превью .docx как HTML -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root {
      --primary: #1a73e8;
      --sidebar-bg: #1a2a44;
      --border: #e0e7ff;
      --text: #202124;
      --bg-light: #f8f9fa;
      --hover: #e8f0fe;
      --error: #d32f2f;
      --ok: #188038;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg-light); color: var(--text); }
    #container { display: flex; min-height: 100vh; }

    aside#sidebar {
      width: 300px; background: var(--sidebar-bg); color: #fff; padding: 20px; overflow-y: auto;
      box-shadow: 2px 0 8px rgba(0,0,0,.08);
    }
    #sidebar h3 { font-size: 18px; margin-bottom: 10px; font-weight: 600; }
    #sidebar .note { font-size: 12px; opacity: .9; margin-bottom: 12px; }
    #templatesList button {
      width: 100%; padding: 12px; margin: 6px 0; background: #334466; color:#fff; border:0; border-radius: 8px;
      text-align: left; cursor: pointer; transition: .2s;
    }
    #templatesList button:hover { background: #405080; }
    #templatesList button.active { background: var(--primary); font-weight: 600; }

    main#right { flex: 1; padding: 20px; background: #fff; overflow-y: auto; }
    h3 { font-size: 18px; margin: 12px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }

    .card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .controls { display: grid; grid-template-columns: 1fr 200px 170px; gap: 10px; align-items: center; margin: 8px 0; }
    @media (max-width: 700px) { .controls { grid-template-columns: 1fr; } }

    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;
    }
    .btn { padding: 12px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-secondary { background: #efefef; }
    .btn-secondary:hover { filter: brightness(.95); }

    .excel-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .excel-table th, .excel-table td { border: 1px solid var(--border); padding: 8px 10px; text-align: left; }
    .excel-table th { background: #f1f3f5; position: sticky; top: 0; z-index: 1; }
    .excel-table tr:hover { background: var(--hover); cursor: pointer; }
    .excel-table tr.selected { background: #d1e7ff; }
    #tableWrap { max-height: 320px; overflow: auto; border: 1px solid var(--border); border-radius: 10px; }

    #preview { min-height: 220px; border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: var(--bg-light); overflow: auto; }
    .error { color: var(--error); font-size: 14px; margin-top: 6px; white-space: pre-wrap; }
    .ok { color: var(--ok); font-size: 14px; }
    .small { font-size: 12px; opacity: .85; }
    .listbox { background: #f7f9ff; border: 1px dashed var(--border); padding: 10px; border-radius: 8px; margin: 6px 0; }
    .diag { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .diag { grid-template-columns: 1fr; } }
    .diag h4 { margin: 6px 0; font-size: 15px; }
    code.k { background: #eee; padding: 2px 6px; border-radius: 6px; display: inline-block; margin: 2px 4px 2px 0; }
  </style>
</head>
<body>
  <div id="container">
    <aside id="sidebar">
      <h3>Шаблоны (.docx)</h3>
      <div class="note">Теги вида <code>[[Поле]]</code>. Шрифты/отступы — как в Word.</div>
      <div id="templatesList">Загрузка…</div>
    </aside>

    <main id="right">
      <div class="grid">

        <section class="card">
          <h3>Реестр (Google Sheets)</h3>
          <div class="controls">
            <input type="text" id="sheetIdInput" placeholder="ID Google-таблицы">
            <input type="number" id="rowInput" placeholder="№ строки (со 2)" min="2">
            <button class="btn btn-secondary" id="reloadSheetBtn">Обновить</button>
          </div>
          <div id="tableWrap"></div>
          <div id="errorTable" class="error"></div>
          <div class="small">Клик по строке — подставит её номер.</div>
        </section>

        <section class="card">
          <h3>Форма письма</h3>
          <div id="preview">Выберите шаблон и строку реестра.</div>
          <div id="errorTpl" class="error"></div>
          <div class="controls" style="grid-template-columns: 1fr 1fr;">
            <button class="btn btn-primary" id="generateBtn">Сформировать превью</button>
            <button class="btn btn-secondary" id="downloadBtn" disabled>Скачать .docx</button>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin-top:0">Диагностика соответствия</h3>
            <div id="diagBox" class="diag">
              <div>
                <h4>Теги в выбранном шаблоне</h4>
                <div id="tplTags" class="listbox small">—</div>
              </div>
              <div>
                <h4>Заголовки в таблице</h4>
                <div id="sheetHeaders" class="listbox small">—</div>
              </div>
            </div>
            <div class="diag">
              <div>
                <h4>Отсутствуют в таблице</h4>
                <div id="missingInSheet" class="listbox small">—</div>
              </div>
              <div>
                <h4>Лишние столбцы (не используются)</h4>
                <div id="unusedHeaders" class="listbox small">—</div>
              </div>
            </div>
            <div class="small">Заголовок столбца должен совпадать с именем тега без скобок. Мелкие расхождения (пробелы/подчёркивания/регистр) система пытается исправить автоматически.</div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script>
    // ===== НАСТРОЙКИ =====
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";

    // Текущий ID Google-таблицы
    const DEFAULT_GOOGLE_SHEET_ID = "17vdbh0KHIZ-lAsqFXp6HtQA-NBymV5Wh";

    // ===== СОСТОЯНИЕ =====
    let templatesMeta = [];          // список .docx из GitHub
    let selectedTemplate = null;     // выбранный шаблон
    let excelHeaders = [];           // заголовки таблицы
    let excelRows = [];              // строки таблицы
    let lastGeneratedBlob = null;    // собранный docx
    let currentTplTags = [];         // теги, найденные в шаблоне

    // ===== UI =====
    const $tplList = document.getElementById('templatesList');
    const $tableWrap = document.getElementById('tableWrap');
    const $rowInput = document.getElementById('rowInput');
    const $sheetIdInput = document.getElementById('sheetIdInput');
    const $reloadSheetBtn = document.getElementById('reloadSheetBtn');
    const $preview = document.getElementById('preview');
    const $errorTpl = document.getElementById('errorTpl');
    const $errorTable = document.getElementById('errorTable');
    const $generateBtn = document.getElementById('generateBtn');
    const $downloadBtn = document.getElementById('downloadBtn');
    const $tplTags = document.getElementById('tplTags');
    const $sheetHeaders = document.getElementById('sheetHeaders');
    const $missingInSheet = document.getElementById('missingInSheet');
    const $unusedHeaders = document.getElementById('unusedHeaders');

    // ===== HELPERS =====
    function setError(el, msg) { el.textContent = msg || ""; }
    function clearPreview() { $preview.innerHTML = "Выберите шаблон и строку реестра."; }
    function csvUrlFromSheetId(id) {
      return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
    }
    function uniq(arr) { return [...new Set(arr)]; }
    function renderKeysBox(el, list) {
      if (!list || !list.length) { el.innerHTML = "—"; return; }
      el.innerHTML = list.map(k => `<code class="k">${k}</code>`).join(" ");
    }

    // «Умная» нормализация ключей (и генерация алиасов)
    function normalizeKey(s) {
      if (!s) return "";
      return s
        .normalize("NFC")
        .replace(/\u00A0/g, ' ')
        .replace(/№/g, 'N')
        .replace(/[.,;:()]/g, '')
        .replace(/\s+/g, '_')
        .replace(/-+/g, '_')
        .replace(/__+/g, '_')
        .trim();
    }
    function makeAliases(header) {
      const h = header ?? "";
      const withUnderscore = h.replace(/\s+/g, '_');
      const withSpaces = h.replace(/_/g, ' ');
      const norm = normalizeKey(h);
      return uniq([h, withUnderscore, withSpaces, h.toLowerCase(), withUnderscore.toLowerCase(), withSpaces.toLowerCase(), norm, norm.toLowerCase()]);
    }
    function buildDataObject(headers, row) {
      const obj = {};
      headers.forEach((h, i) => {
        const val = row[i] ?? "";
        makeAliases(h).forEach(alias => { obj[alias] = val; });
      });
      return obj;
    }

    // ===== ЗАГРУЗКА ШАБЛОНОВ (.docx) ИЗ GITHUB =====
    async function fetchTemplatesList() {
      try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error("GitHub API error");
        const files = await res.json();
        templatesMeta = files.filter(f => /\.docx$/i.test(f.name));
        renderTemplatesList();
      } catch (e) {
        $tplList.innerHTML = "Ошибка загрузки шаблонов";
      }
    }
    function renderTemplatesList() {
      if (!templatesMeta.length) { $tplList.innerHTML = "Нет .docx-шаблонов в /templates"; return; }
      $tplList.innerHTML = templatesMeta.map((t, idx) =>
        `<button id="tplbtn-${idx}" onclick="selectTemplate(${idx})" title="${t.name.replace(/\.docx$/i,'')}">${t.name.replace(/\.docx$/i,'')}</button>`
      ).join("");
    }

    window.selectTemplate = async function(idx) {
      document.querySelectorAll('#templatesList button').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById(`tplbtn-${idx}`); if (btn) btn.classList.add('active');
      selectedTemplate = templatesMeta[idx];
      setError($errorTpl, "");
      clearPreview();
      $downloadBtn.disabled = true;
      lastGeneratedBlob = null;

      // извлечём теги из .docx для диагностики (формат [[...]])
      currentTplTags = await extractDocxTags(selectedTemplate.download_url);
      renderKeysBox($tplTags, currentTplTags);
      updateDiagnostics();
    };

    // Извлекаем все [[теги]] из docx (документ + хедеры/футеры)
    async function extractDocxTags(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Не удалось загрузить шаблон");
        const ab = await res.arrayBuffer();
        const zip = new PizZip(ab);

        const xmlNames = Object.keys(zip.files).filter(n => n.startsWith('word/') && n.endsWith('.xml'));
        const tagSet = new Set();
        const rgx = /\[\[\s*([^\]]+?)\s*\]\]/g;

        xmlNames.forEach(name => {
          try {
            const txt = zip.files[name].asText();
            let m;
            while ((m = rgx.exec(txt)) !== null) {
              const raw = m[1].trim();
              const base = raw.split('|')[0].trim(); // если будут модификаторы
              tagSet.add(base);
            }
          } catch (_) {}
        });

        return Array.from(tagSet).sort((a,b)=>a.localeCompare(b));
      } catch (e) {
        console.warn("extractDocxTags error:", e);
        return [];
      }
    }

    // ===== GOOGLE SHEETS (CSV) =====
    async function loadGoogleSheet(sheetId) {
      try {
        setError($errorTable, "");
        const res = await fetch(csvUrlFromSheetId(sheetId));
        if (!res.ok) throw new Error("Не удалось загрузить таблицу (проверьте доступ по ссылке)");
        const csv = await res.text();
        const wb = XLSX.read(csv, { type: 'string' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (!json.length) throw new Error("Пустая таблица");
        excelHeaders = json[0].map(h => (h ?? "").toString().trim());
        excelRows = json.slice(1);
        renderTable();
        renderKeysBox($sheetHeaders, excelHeaders);
        updateDiagnostics();
      } catch (e) {
        $tableWrap.innerHTML = "";
        renderKeysBox($sheetHeaders, []);
        setError($errorTable, e.message || "Ошибка загрузки таблицы");
        updateDiagnostics();
      }
    }

    function renderTable() {
      if (!excelHeaders.length) { $tableWrap.innerHTML = ""; return; }
      let html = `<table class="excel-table"><thead><tr>`;
      excelHeaders.forEach(h => html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      excelRows.forEach((row, i) => {
        html += `<tr onclick="pickRow(${i})" class="${(parseInt($rowInput.value)-2===i)?'selected':''}">`;
        excelHeaders.forEach((h, j) => html += `<td>${row[j] ?? ''}</td>`);
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      $tableWrap.innerHTML = html;
    }

    window.pickRow = function(i) {
      $rowInput.value = i + 2;
      renderTable();
    }

    // ===== ДИАГНОСТИКА (сопоставление тегов и заголовков) =====
    function updateDiagnostics() {
      const hdrAliases = new Map(); // alias -> оригинальный header
      excelHeaders.forEach(h => { makeAliases(h).forEach(a => hdrAliases.set(a, h)); });

      const missing = [];
      const usedHeaders = new Set();

      currentTplTags.forEach(tag => {
        const candidates = uniq([
          tag, tag.toLowerCase(),
          normalizeKey(tag), normalizeKey(tag).toLowerCase(),
          tag.replace(/\s+/g,'_'),
          tag.replace(/_/g,' ')
        ]);
        let matchedHeader = null;
        for (const c of candidates) {
          if (hdrAliases.has(c)) { matchedHeader = hdrAliases.get(c); break; }
        }
        if (!matchedHeader) missing.push(tag);
        else usedHeaders.add(matchedHeader);
      });

      const unused = excelHeaders.filter(h => !usedHeaders.has(h));

      renderKeysBox($missingInSheet, missing);
      renderKeysBox($unusedHeaders, unused);
    }

    // ===== ГЕНЕРАЦИЯ DOCX + PREVIEW (для [[...]]) =====
    async function fetchArrayBuffer(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Не удалось загрузить шаблон");
      return await res.arrayBuffer();
    }

    async function generateDocxAndPreview() {
      setError($errorTpl, "");
      $downloadBtn.disabled = true;
      lastGeneratedBlob = null;

      if (!selectedTemplate) { setError($errorTpl, "Выберите шаблон (.docx) слева"); return; }
      const rowNum = parseInt($rowInput.value);
      if (isNaN(rowNum) || rowNum < 2 || rowNum - 2 >= excelRows.length) {
        setError($errorTpl, "Введите корректный номер строки реестра");
        return;
      }

      try {
        const ab = await fetchArrayBuffer(selectedTemplate.download_url);
        const zip = new PizZip(ab);

        // ВАЖНО: указываем новые разделители [[...]]
        const doc = new window.docxtemplater(zip, {
          delimiters: { start: '[[', end: ']]' }
        });

        const data = buildDataObject(excelHeaders, excelRows[rowNum - 2]);
        doc.setData(data);

        try {
          doc.render();
        } catch (e) {
          let details = "";
          if (e.properties && e.properties.errors) {
            details = e.properties.errors.map(err => `• ${err.properties?.explanation || err.properties?.id || err.message || "Ошибка"}`).join("\n");
          }
          throw new Error("Ошибка формирования шаблона.\n" + details + "\nПроверьте совпадение тегов и заголовков (см. «Диагностика соответствия»).");
        }

        const out = doc.getZip().generate({ type: "blob" });
        lastGeneratedBlob = out;

        // Превью
        const buf = await out.arrayBuffer();
        const result = await window.mammoth.convertToHtml({ arrayBuffer: buf });
        $preview.innerHTML = result.value || "<i>(Превью пустое — но .docx сформирован)</i>";
        $downloadBtn.disabled = false;

        updateDiagnostics();
      } catch (e) {
        console.error(e);
        setError($errorTpl, e.message || "Ошибка формирования. Проверьте соответствие тегов и заголовков.");
      }
    }

    function downloadDocx() {
      if (!lastGeneratedBlob || !selectedTemplate) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(lastGeneratedBlob);
      a.href = url;
      const cleanName = selectedTemplate.name.replace(/\.docx$/i, '');
      const rowNum = parseInt($rowInput.value) || 'X';
      a.download = `${cleanName}_${rowNum}.docx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== СВЯЗКА UI =====
    $sheetIdInput.value = DEFAULT_GOOGLE_SHEET_ID;
    $reloadSheetBtn.addEventListener('click', () => loadGoogleSheet($sheetIdInput.value.trim()));
    $generateBtn.addEventListener('click', generateDocxAndPreview);
    $downloadBtn.addEventListener('click', downloadDocx);

    // Автообновление таблицы каждые 5 минут
    setInterval(() => {
      const id = $sheetIdInput.value.trim();
      if (id) loadGoogleSheet(id);
    }, 5 * 60 * 1000);

    // Первичная загрузка
    fetchTemplatesList();
    loadGoogleSheet(DEFAULT_GOOGLE_SHEET_ID);
  </script>
</body>
</html>
