<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–∏—Å–µ–º ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ([[...]] —Ç–µ–≥–∏)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- UI-—à—Ä–∏—Ñ—Ç -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- CSV / Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- DocxTemplater + PizZip -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.38.0/build/docxtemplater.js"></script>

  <!-- Mammoth: –ø—Ä–µ–≤—å—é .docx –∫–∞–∫ HTML -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root{
      --primary:#1a73e8;--sidebar-bg:#1a2a44;--border:#e0e7ff;--text:#202124;--bg:#fff;--bg-light:#f7f9fc;
      --hover:#e8f0fe;--error:#d32f2f;--ok:#188038;--warning:#f57c00;--shadow:0 6px 24px rgba(0,0,0,.06);
      --success-bg:#e8f5e8;--warning-bg:#fff3e0;--error-bg:#ffebee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg-light)}

    .appbar{position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;padding:10px 12px}
    .app-title{font-weight:600}
    .spacer{flex:1}
    .icon-btn{appearance:none;border:0;background:transparent;cursor:pointer;padding:8px;border-radius:10px}
    .icon-btn:hover{background:#f1f5ff}
    .ham{width:24px;height:2px;background:#222;position:relative;display:block}
    .ham::before,.ham::after{content:"";position:absolute;left:0;right:0;height:2px;background:#222}
    .ham::before{top:-7px}.ham::after{top:7px}

    .layout{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 54px)}
    aside#sidebar{background:var(--sidebar-bg);color:#fff;padding:16px;border-right:1px solid rgba(255,255,255,.08);overflow:auto}
    .sb-title{font-size:16px;font-weight:600;margin-bottom:10px}
    .sb-note{font-size:12px;opacity:.9;margin-bottom:10px}
    .sb-search input{width:100%;padding:9px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;margin-bottom:10px}
    .tpl-list{display:grid;gap:6px}
    .tpl-btn{width:100%;text-align:left;background:#334466;color:#fff;border:0;border-radius:8px;padding:10px;cursor:pointer;transition:.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tpl-btn:hover{background:#3b4e78}
    .tpl-btn.active{background:var(--primary);font-weight:600}

    main{padding:16px;overflow:auto}
    .card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);margin-bottom:12px}
    h3{margin:6px 0 10px;font-size:16px}

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
    .filters-section{margin-bottom:16px}
    .filters-tabs{display:flex;gap:4px;margin-bottom:12px}
    .filter-tab{padding:8px 16px;border:1px solid var(--border);background:var(--bg-light);border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;transition:.2s}
    .filter-tab.active{background:var(--bg);border-bottom-color:var(--bg);font-weight:500}
    .filter-tab:hover:not(.active){background:var(--hover)}

    .filter-content{border:1px solid var(--border);border-radius:0 8px 8px 8px;padding:12px;background:var(--bg)}
    .filter-content.hidden{display:none}

    /* –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä */
    .text-filter-wrapper{position:relative}
    .filter-help{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;color:#666;cursor:help}
    .filter-tooltip{position:absolute;top:100%;right:0;background:#333;color:#fff;padding:8px;border-radius:6px;font-size:12px;width:300px;z-index:100;display:none}
    .filter-help:hover + .filter-tooltip{display:block}

    /* –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
    .visual-filters{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px}
    .filter-group{display:flex;flex-direction:column;gap:4px}
    .filter-label{font-size:12px;color:#666;font-weight:500}
    .filter-select{padding:8px;border:1px solid var(--border);border-radius:6px;background:#fff}

    .record-selection{display:grid;grid-template-columns:1fr 140px;gap:8px;align-items:center}
    .record-selection input, .record-selection select{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}

    /* –°—Ç–∞—Ç—É—Å—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
    .validation-status{padding:8px 12px;border-radius:6px;font-size:13px;margin:8px 0}
    .validation-status.success{background:var(--success-bg);color:var(--ok);border:1px solid var(--ok)}
    .validation-status.warning{background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning)}
    .validation-status.error{background:var(--error-bg);color:var(--error);border:1px solid var(--error)}

    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö */
    .data-preview{background:#f8f9ff;border:1px solid #e1e5ff;border-radius:8px;padding:12px;margin:8px 0}
    .preview-title{font-weight:500;margin-bottom:8px;color:#1a73e8}
    .preview-fields{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:8px}
    .preview-field{display:flex;flex-direction:column;gap:2px}
    .field-name{font-size:11px;color:#666;font-weight:500;text-transform:uppercase}
    .field-value{font-size:13px;padding:4px 8px;background:#fff;border:1px solid #e0e7ff;border-radius:4px;min-height:20px}
    .field-value.empty{color:#999;font-style:italic}

    .muted{font-size:12px;opacity:.8}
    .link{color:var(--primary);cursor:pointer}
    .link:hover{text-decoration:underline}

    #preview{min-height:220px;border:1px solid var(--border);border-radius:10px;background:#fafbff;padding:12px;overflow:auto}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#eef1f7}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}

    .error{color:var(--error);font-size:13px;margin-top:6px;white-space:pre-wrap}

    .drawer{display:none;margin-top:8px}
    .drawer.open{display:block}
    .table-wrap{border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:55vh;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#f4f6fb;z-index:1}

    .scrim{position:fixed;inset:0;background:rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.2s;z-index:55}
    .scrim.show{opacity:1;pointer-events:auto}
    .drawer-side{position:fixed;inset:0 30% 0 0;max-width:80vw;background:var(--sidebar-bg);color:#fff;padding:14px;transform:translateX(-100%);transition:transform .2s ease;z-index:60;overflow:auto;border-right:1px solid rgba(255,255,255,.08)}
    .drawer-side.open{transform:none}

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid #f3f3f3;border-top:2px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .notification{position:fixed;top:70px;right:16px;background:var(--success-bg);color:var(--ok);border:1px solid var(--ok);padding:12px 16px;border-radius:8px;z-index:100;transform:translateX(100%);transition:.3s;box-shadow:var(--shadow)}
    .notification.show{transform:translateX(0)}

    @media (max-width:1199px){ .layout{grid-template-columns:260px 1fr} }
    @media (max-width:767px){
      .layout{display:block}
      aside#sidebar{display:none}
      .record-selection{grid-template-columns:1fr}
      .record-selection input#rowNumberInput{grid-column:1}
      .visual-filters{grid-template-columns:1fr 1fr}
      .preview-fields{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="appbar">
    <button id="menuBtn" class="icon-btn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é"><span class="ham"></span></button>
    <div class="app-title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–∏—Å–µ–º</div>
    <div class="spacer"></div>
  </div>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="notification" class="notification"></div>

  <!-- Mobile sidebar drawer -->
  <div id="scrim" class="scrim" aria-hidden="true"></div>
  <aside id="drawerSide" class="drawer-side" aria-hidden="true">
    <div class="sb-title">–®–∞–±–ª–æ–Ω—ã (.docx)</div>
    <div class="sb-note">–¢–µ–≥–∏ <code>[[–ü–æ–ª–µ]]</code>. –®—Ä–∏—Ñ—Ç—ã/–æ—Ç—Å—Ç—É–ø—ã ‚Äî –∫–∞–∫ –≤ Word.</div>
    <div class="sb-search"><input id="tplSearchMobile" placeholder="–ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–∞‚Ä¶"></div>
    <div id="tplListMobile" class="tpl-list">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </aside>

  <div class="layout">
    <!-- Sidebar (tablet/desktop) -->
    <aside id="sidebar">
      <div class="sb-title">–®–∞–±–ª–æ–Ω—ã (.docx)</div>
      <div class="sb-note">–¢–µ–≥–∏ <code>[[–ü–æ–ª–µ]]</code>. –®—Ä–∏—Ñ—Ç—ã/–æ—Ç—Å—Ç—É–ø—ã ‚Äî –∫–∞–∫ –≤ Word.</div>
      <div class="sb-search"><input id="tplSearch" placeholder="–ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–∞‚Ä¶"></div>
      <div id="templatesList" class="tpl-list">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </aside>

    <main>
      <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <section class="card">
        <h3>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
        <div class="filters-section">
          <div class="filters-tabs">
            <div class="filter-tab active" data-tab="text">üîç –¢–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫</div>
            <div class="filter-tab" data-tab="visual">üéõÔ∏è –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</div>
          </div>
          
          <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä -->
          <div class="filter-content" id="textFilter">
            <div class="text-filter-wrapper">
              <input id="smartQuery" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º (–ø—Ä–∏–º–µ—Ä: –§–∏–ª–∏–∞–ª=–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –û–°=–†–æ—Å—Ç–µ–ª–µ–∫–æ–º ¬´–ù–æ–º–µ—Ä_–¢–£=123¬ª). –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç ‚Äî –æ–±—â–∏–π –ø–æ–∏—Å–∫">
              <span class="filter-help">?</span>
              <div class="filter-tooltip">
                <strong>–ü—Ä–∏–º–µ—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤:</strong><br>
                ‚Ä¢ <code>–ò–≤–∞–Ω–æ–≤</code> ‚Äî –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º<br>
                ‚Ä¢ <code>–§–∏–ª–∏–∞–ª=–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ</code> ‚Äî —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ<br>
                ‚Ä¢ <code>–û–°=–†–æ—Å—Ç–µ–ª–µ–∫–æ–º –ù–æ–º–µ—Ä_–¢–£=123</code> ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª–æ–≤–∏–π<br>
                ‚Ä¢ <code>¬´–ù–æ–º–µ—Ä –¢–£=456¬ª</code> ‚Äî –ø–æ–ª—è —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
              </div>
            </div>
          </div>

          <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
          <div class="filter-content hidden" id="visualFilter">
            <div class="visual-filters" id="visualFiltersContainer">
              <div class="filter-group">
                <div class="filter-label">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤...</div>
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-secondary" id="clearFilters">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</button>
            </div>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
        <div id="validationStatus" class="validation-status" style="display:none"></div>

        <!-- –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ -->
        <div class="record-selection">
          <select id="recordSelect"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å ‚Äî</option></select>
          <input id="rowNumberInput" type="number" min="2" placeholder="‚Ññ —Å—Ç—Ä–æ–∫–∏ (—Å–æ 2)">
        </div>
        
        <div class="muted" style="margin-top:6px">
          <span id="matchInfo">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π: 0</span> ‚Ä¢
          <span class="link" id="toggleRegistry">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–µ—Å—Ç—Ä</span> ‚Ä¢
          <span class="link" id="toggleDiag">–ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</span>
        </div>
      </section>

      <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∏ -->
      <section class="card" id="dataPreviewCard" style="display:none">
        <h3>üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∏</h3>
        <div id="dataPreview" class="data-preview">
          <div class="preview-title">–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —à–∞–±–ª–æ–Ω:</div>
          <div class="preview-fields" id="previewFields"></div>
        </div>
        <div class="muted">–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞</div>
      </section>

      <!-- –ü—Ä–µ–≤—å—é –ø–∏—Å—å–º–∞ + –¥–µ–π—Å—Ç–≤–∏—è -->
      <section class="card">
        <h3>üìÑ –ü–∏—Å—å–º–æ</h3>
        <div id="preview">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏ –∑–∞–¥–∞–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä/—Å—Ç—Ä–æ–∫—É.</div>
        <div id="errorTpl" class="error"></div>
        <div class="actions">
          <button class="btn btn-primary" id="downloadBtn" disabled>
            <span class="btn-text">–°–∫–∞—á–∞—Ç—å .docx</span>
            <span class="loading-spinner" style="display:none"></span>
          </button>
          <button class="btn btn-secondary" id="copyBtn" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ</button>
        </div>
      </section>

      <!-- –°–∫—Ä—ã—Ç—ã–µ —Ä–∞–∑–¥–µ–ª—ã -->
      <section class="card drawer" id="registryDrawer">
        <h3 style="margin-top:0">–†–µ–µ—Å—Ç—Ä (–ø—Ä–æ—Å–º–æ—Ç—Ä)</h3>
        <div class="table-wrap" id="tableWrap"></div>
      </section>

      <section class="card drawer" id="diagDrawer">
        <h3 style="margin-top:0">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
        <div class="muted">–¢–µ–≥–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —à–∞–±–ª–æ–Ω–µ</div>
        <div id="tplTags" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">‚Äî</div>
        <div class="muted" style="margin-top:8px">–ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ</div>
        <div id="sheetHeaders" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">‚Äî</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
          <div>
            <div class="muted">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ</div>
            <div id="missingInSheet" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">‚Äî</div>
          </div>
          <div>
            <div class="muted">–õ–∏—à–Ω–∏–µ —Å—Ç–æ–ª–±—Ü—ã</div>
            <div id="unusedHeaders" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">‚Äî</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";
    const DEFAULT_GOOGLE_SHEET_ID = "17vdbh0KHIZ-lAsqFXp6HtQA-NBymV5Wh";

    // ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
    let templatesMeta = [];
    let selectedTemplate = null;
    let excelHeaders = [];
    let excelRows = [];
    let currentTplTags = [];
    let lastGeneratedBlob = null;
    let visualFilters = {};

    // ===== UI =====
    const $menuBtn = document.getElementById('menuBtn');
    const $drawerSide = document.getElementById('drawerSide');
    const $scrim = document.getElementById('scrim');

    const $tplSearch = document.getElementById('tplSearch');
    const $tplSearchMobile = document.getElementById('tplSearchMobile');
    const $sidebarList = document.getElementById('templatesList');
    const $tplListMobile = document.getElementById('tplListMobile');

    const $smartQuery = document.getElementById('smartQuery');
    const $recordSelect = document.getElementById('recordSelect');
    const $rowNumberInput = document.getElementById('rowNumberInput');
    const $matchInfo = document.getElementById('matchInfo');

    const $preview = document.getElementById('preview');
    const $errorTpl = document.getElementById('errorTpl');
    const $downloadBtn = document.getElementById('downloadBtn');
    const $copyBtn = document.getElementById('copyBtn');

    const $tableWrap = document.getElementById('tableWrap');
    const $toggleRegistry = document.getElementById('toggleRegistry');
    const $toggleDiag = document.getElementById('toggleDiag');
    const $registryDrawer = document.getElementById('registryDrawer');
    const $diagDrawer = document.getElementById('diagDrawer');

    const $tplTags = document.getElementById('tplTags');
    const $sheetHeaders = document.getElementById('sheetHeaders');
    const $missingInSheet = document.getElementById('missingInSheet');
    const $unusedHeaders = document.getElementById('unusedHeaders');

    const $validationStatus = document.getElementById('validationStatus');
    const $dataPreviewCard = document.getElementById('dataPreviewCard');
    const $previewFields = document.getElementById('previewFields');
    const $notification = document.getElementById('notification');

    // ===== HELPERS =====
    const isMobile = () => window.matchMedia("(max-width: 767px)").matches;
    function setError(el, msg){ el.textContent = msg || ""; }
    function clearPreview(){ $preview.innerHTML = "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏ –∑–∞–¥–∞–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä/—Å—Ç—Ä–æ–∫—É."; $downloadBtn.disabled = true; $copyBtn.disabled = true; }
    function csvUrlFromSheetId(id){ return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`; }
    const uniq = arr => [...new Set(arr)];
    const renderChips = list => (!list||!list.length) ? "‚Äî" : list.map(k=>`<code style="background:#eee;border-radius:6px;padding:2px 6px;margin:2px 4px 0 0;display:inline-block">${k}</code>`).join(" ");

    function normalizeKey(s){
      if(!s) return "";
      return s.normalize("NFC").replace(/\u00A0/g,' ').replace(/‚Ññ/g,'N').replace(/[.,;:()]/g,'').replace(/\s+/g,'_').replace(/-+/g,'_').replace(/__+/g,'_').trim();
    }
    function makeAliases(header){
      const h = header ?? "";
      const withUnderscore = h.replace(/\s+/g,'_');
      const withSpaces = h.replace(/_/g,' ');
      const norm = normalizeKey(h);
      return uniq([h, withUnderscore, withSpaces, h.toLowerCase(), withUnderscore.toLowerCase(), withSpaces.toLowerCase(), norm, norm.toLowerCase()]);
    }
    function buildDataObject(headers,row){
      const obj={};
      headers.forEach((h,i)=>{ makeAliases(h).forEach(alias=>obj[alias] = row[i] ?? ""); });
      return obj;
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message, type = 'success') {
      $notification.textContent = message;
      $notification.className = `notification ${type}`;
      $notification.classList.add('show');
      setTimeout(() => $notification.classList.remove('show'), 3000);
    }

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    function setLoading(button, loading) {
      const spinner = button.querySelector('.loading-spinner');
      const text = button.querySelector('.btn-text');
      if (loading) {
        spinner.style.display = 'inline-block';
        text.style.display = 'none';
        button.disabled = true;
      } else {
        spinner.style.display = 'none';
        text.style.display = 'inline';
        button.disabled = false;
      }
    }

    // ===== –§–ò–õ–¨–¢–†–´ =====
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.filter-content').forEach(c => c.classList.add('hidden'));
        
        tab.classList.add('active');
        const targetTab = tab.getAttribute('data-tab');
        document.getElementById(targetTab + 'Filter').classList.remove('hidden');
      });
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function createVisualFilters() {
      if (!excelHeaders.length) return;
      
      const container = document.getElementById('visualFiltersContainer');
      const importantFields = ['–§–∏–ª–∏–∞–ª', '–û–°', '–ö–æ–º—É_–§–ò–û', '–§–ò–û', '–¢–∏–ø_–¥–æ–∫—É–º–µ–Ω—Ç–∞'];
      const fieldsToShow = [];
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      importantFields.forEach(field => {
        const found = excelHeaders.find(h => 
          h === field || h.toLowerCase() === field.toLowerCase() || 
          normalizeKey(h) === normalizeKey(field)
        );
        if (found) fieldsToShow.push(found);
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (–º–∞–∫—Å–∏–º—É–º 6 –≤—Å–µ–≥–æ)
      excelHeaders.forEach(h => {
        if (fieldsToShow.length < 6 && !fieldsToShow.includes(h)) {
          fieldsToShow.push(h);
        }
      });

      container.innerHTML = fieldsToShow.map(header => {
        const uniqueValues = [...new Set(excelRows.map(row => {
          const idx = excelHeaders.indexOf(header);
          return row[idx] || '';
        }))].filter(v => v.trim() !== '').sort().slice(0, 50); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 50 –∑–Ω–∞—á–µ–Ω–∏–π

        return `
          <div class="filter-group">
            <div class="filter-label">${header}</div>
            <select class="filter-select" data-field="${header}">
              <option value="">–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è</option>
              ${uniqueValues.map(val => `<option value="${val}">${val}</option>`).join('')}
            </select>
          </div>
        `;
      }).join('');

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      container.querySelectorAll('.filter-select').forEach(select => {
        select.addEventListener('change', applyVisualFilters);
      });
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyVisualFilters() {
      const filters = {};
      document.querySelectorAll('.filter-select').forEach(select => {
        if (select.value) {
          filters[select.dataset.field] = select.value;
        }
      });
      
      visualFilters = filters;
      refreshSmartFilter();
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.querySelectorAll('.filter-select').forEach(select => {
        select.value = '';
      });
      visualFilters = {};
      refreshSmartFilter();
    });

    // ===== –í–ê–õ–ò–î–ê–¶–ò–Ø =====
    function validateCurrentSelection() {
      const status = $validationStatus;
      
      if (!selectedTemplate) {
        showValidationStatus('–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞', 'warning');
        return false;
      }
      
      if (!excelRows.length) {
        showValidationStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'error');
        return false;
      }
      
      const recIdx = getSelectedRecordIndex();
      if (recIdx === null) {
        showValidationStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏', 'warning');
        return false;
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
      const record = excelRows[recIdx];
      const dataObject = buildDataObject(excelHeaders, record);
      const emptyFields = currentTplTags.filter(tag => !dataObject[tag] || dataObject[tag].toString().trim() === '');
      
      if (emptyFields.length > 0) {
        showValidationStatus(`–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—É—Å—Ç—ã–µ –ø–æ–ª—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏: ${emptyFields.join(', ')}`, 'warning');
        return true; // –†–∞–∑—Ä–µ—à–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
      }
      
      showValidationStatus('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'success');
      return true;
    }

    function showValidationStatus(message, type) {
      $validationStatus.textContent = message;
      $validationStatus.className = `validation-status ${type}`;
      $validationStatus.style.display = 'block';
    }

    function hideValidationStatus() {
      $validationStatus.style.display = 'none';
    }

    // ===== –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –î–ê–ù–ù–´–• =====
    function updateDataPreview() {
      const recIdx = getSelectedRecordIndex();
      
      if (recIdx === null || !excelHeaders.length) {
        $dataPreviewCard.style.display = 'none';
        return;
      }
      
      const record = excelRows[recIdx];
      const dataObject = buildDataObject(excelHeaders, record);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω–µ, –ø–ª—é—Å –æ—Å–Ω–æ–≤–Ω—ã–µ
      const mainFields = ['–ö–æ–º—É_–§–ò–û', '–§–ò–û', '–§–∏–ª–∏–∞–ª', '–û–°', '–ù–æ–º–µ—Ä_–¢–£', '–ù–æ–º–µ—Ä_–¥–æ–∫—É–º–µ–Ω—Ç–∞'];
      const fieldsToShow =
