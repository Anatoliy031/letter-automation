<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Автоматизация писем — упрощённый интерфейс ([[...]] теги)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- UI-шрифт -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- CSV / Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- DocxTemplater + PizZip -->
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.38.0/build/docxtemplater.js"></script>

  <!-- Mammoth: превью .docx как HTML -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <style>
    :root{
      --primary:#1a73e8;--sidebar-bg:#1a2a44;--border:#e0e7ff;--text:#202124;--bg:#fff;--bg-light:#f7f9fc;
      --hover:#e8f0fe;--error:#d32f2f;--ok:#188038;--shadow:0 6px 24px rgba(0,0,0,.06)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg-light)}

    /* Top App Bar */
    .appbar{position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;padding:10px 12px}
    .app-title{font-weight:600}
    .spacer{flex:1}
    .icon-btn{appearance:none;border:0;background:transparent;cursor:pointer;padding:8px;border-radius:10px}
    .icon-btn:hover{background:#f1f5ff}
    .ham{width:24px;height:2px;background:#222;position:relative;display:block}
    .ham::before,.ham::after{content:"";position:absolute;left:0;right:0;height:2px;background:#222}
    .ham::before{top:-7px}.ham::after{top:7px}

    /* Layout */
    .layout{display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 54px)}
    aside#sidebar{background:var(--sidebar-bg);color:#fff;padding:16px;border-right:1px solid rgba(255,255,255,.08);overflow:auto}
    .sb-title{font-size:16px;font-weight:600;margin-bottom:10px}
    .sb-note{font-size:12px;opacity:.9;margin-bottom:10px}
    .sb-search input{width:100%;padding:9px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;margin-bottom:10px}
    .tpl-list{display:grid;gap:6px}
    .tpl-btn{width:100%;text-align:left;background:#334466;color:#fff;border:0;border-radius:8px;padding:10px;cursor:pointer;transition:.15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tpl-btn:hover{background:#3b4e78}
    .tpl-btn.active{background:var(--primary);font-weight:600}

    main{padding:16px;overflow:auto}
    .card{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);margin-bottom:12px}
    h3{margin:6px 0 10px;font-size:16px}

    .filters{display:grid;grid-template-columns:1fr 200px;gap:8px;align-items:center}
    .filters input, .filters select{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
    .muted{font-size:12px;opacity:.8}
    .link{color:var(--primary);cursor:pointer}
    .link:hover{text-decoration:underline}

    #preview{min-height:220px;border:1px solid var(--border);border-radius:10px;background:#fafbff;padding:12px;overflow:auto}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#eef1f7}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .error{color:var(--error);font-size:13px;margin-top:6px;white-space:pre-wrap}

    /* Hidden drawers */
    .drawer{display:none;margin-top:8px}
    .drawer.open{display:block}
    .table-wrap{border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:55vh;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    thead th{position:sticky;top:0;background:#f4f6fb;z-index:1}

    /* Mobile drawer */
    .scrim{position:fixed;inset:0;background:rgba(0,0,0,.3);opacity:0;pointer-events:none;transition:.2s;z-index:55}
    .scrim.show{opacity:1;pointer-events:auto}
    .drawer-side{position:fixed;inset:0 30% 0 0;max-width:80vw;background:var(--sidebar-bg);color:#fff;padding:14px;transform:translateX(-100%);transition:transform .2s ease;z-index:60;overflow:auto;border-right:1px solid rgba(255,255,255,.08)}
    .drawer-side.open{transform:none}

    @media (max-width:1199px){ .layout{grid-template-columns:260px 1fr} }
    @media (max-width:767px){
      .layout{display:block}
      aside#sidebar{display:none}
      .filters{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- App bar -->
  <div class="appbar">
    <button id="menuBtn" class="icon-btn" aria-label="Открыть меню">
      <span class="ham"></span>
    </button>
    <div class="app-title">Автоматизация писем</div>
    <div class="spacer"></div>
  </div>

  <!-- Mobile sidebar drawer -->
  <div id="scrim" class="scrim" aria-hidden="true"></div>
  <aside id="drawerSide" class="drawer-side" aria-hidden="true">
    <div class="sb-title">Шаблоны (.docx)</div>
    <div class="sb-note">Теги <code>[[Поле]]</code>. Шрифты/отступы — как в Word.</div>
    <div class="sb-search">
      <input id="tplSearchMobile" placeholder="Поиск шаблона…">
    </div>
    <div id="tplListMobile" class="tpl-list">Загрузка…</div>
  </aside>

  <div class="layout">
    <!-- Sidebar (tablet/desktop) -->
    <aside id="sidebar">
      <div class="sb-title">Шаблоны (.docx)</div>
      <div class="sb-note">Теги <code>[[Поле]]</code>. Шрифты/отступы — как в Word.</div>
      <div class="sb-search"><input id="tplSearch" placeholder="Поиск шаблона…"></div>
      <div id="templatesList" class="tpl-list">Загрузка…</div>
    </aside>

    <main>
      <!-- Умные фильтры + выбор записи -->
      <section class="card">
        <h3>Данные для письма</h3>
        <div class="filters">
          <input id="smartQuery" placeholder="Фильтр по всем полям (пример: Филиал=Тихорецкие ОС=Ростелеком «Номер_ТУ=123»). Просто текст — общий поиск">
          <select id="recordSelect"><option value="">— выберите запись —</option></select>
        </div>
        <div class="muted" style="margin-top:6px">
          <span id="matchInfo">Совпадений: 0</span> •
          <span class="link" id="toggleRegistry">Показать реестр</span> •
          <span class="link" id="toggleDiag">Показать диагностику</span>
        </div>
      </section>

      <!-- Превью письма + действия -->
      <section class="card">
        <h3>Письмо</h3>
        <div id="preview">Выберите шаблон и задайте фильтр, чтобы выбрать строку.</div>
        <div id="errorTpl" class="error"></div>
        <div class="actions">
          <button class="btn btn-primary" id="downloadBtn" disabled>Скачать .docx</button>
          <button class="btn btn-secondary" id="copyBtn" disabled>Скопировать письмо</button>
        </div>
      </section>

      <!-- Скрытые разделы -->
      <section class="card drawer" id="registryDrawer">
        <h3 style="margin-top:0">Реестр (просмотр)</h3>
        <div class="table-wrap" id="tableWrap"></div>
      </section>

      <section class="card drawer" id="diagDrawer">
        <h3 style="margin-top:0">Диагностика соответствия</h3>
        <div class="muted">Теги в выбранном шаблоне</div>
        <div id="tplTags" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">—</div>
        <div class="muted" style="margin-top:8px">Заголовки в таблице</div>
        <div id="sheetHeaders" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">—</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
          <div>
            <div class="muted">Отсутствуют в таблице</div>
            <div id="missingInSheet" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">—</div>
          </div>
          <div>
            <div class="muted">Лишние столбцы</div>
            <div id="unusedHeaders" class="table-wrap" style="padding:8px;border:1px dashed var(--border);border-radius:10px;background:#f7f9ff">—</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== НАСТРОЙКИ =====
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";
    const DEFAULT_GOOGLE_SHEET_ID = "17vdbh0KHIZ-lAsqFXp6HtQA-NBymV5Wh";

    // ===== СОСТОЯНИЕ =====
    let templatesMeta = [];
    let selectedTemplate = null;
    let excelHeaders = [];
    let excelRows = [];
    let currentTplTags = [];
    let lastGeneratedBlob = null;

    // ===== UI =====
    const $menuBtn = document.getElementById('menuBtn');
    const $drawerSide = document.getElementById('drawerSide');
    const $scrim = document.getElementById('scrim');

    const $tplSearch = document.getElementById('tplSearch');
    const $tplSearchMobile = document.getElementById('tplSearchMobile');
    const $sidebarList = document.getElementById('templatesList');
    const $tplListMobile = document.getElementById('tplListMobile');

    const $smartQuery = document.getElementById('smartQuery');
    const $recordSelect = document.getElementById('recordSelect');
    const $matchInfo = document.getElementById('matchInfo');

    const $preview = document.getElementById('preview');
    const $errorTpl = document.getElementById('errorTpl');
    const $downloadBtn = document.getElementById('downloadBtn');
    const $copyBtn = document.getElementById('copyBtn');

    const $tableWrap = document.getElementById('tableWrap');
    const $toggleRegistry = document.getElementById('toggleRegistry');
    const $toggleDiag = document.getElementById('toggleDiag');
    const $registryDrawer = document.getElementById('registryDrawer');
    const $diagDrawer = document.getElementById('diagDrawer');

    const $tplTags = document.getElementById('tplTags');
    const $sheetHeaders = document.getElementById('sheetHeaders');
    const $missingInSheet = document.getElementById('missingInSheet');
    const $unusedHeaders = document.getElementById('unusedHeaders');

    // ===== HELPERS =====
    const isMobile = () => window.matchMedia("(max-width: 767px)").matches;
    function setError(el, msg){ el.textContent = msg || ""; }
    function clearPreview(){ $preview.innerHTML = "Выберите шаблон и задайте фильтр/запись."; $downloadBtn.disabled = true; $copyBtn.disabled = true; }
    function csvUrlFromSheetId(id){ return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`; }
    const uniq = arr => [...new Set(arr)];
    const renderChips = list => (!list||!list.length) ? "—" : list.map(k=>`<code style="background:#eee;border-radius:6px;padding:2px 6px;margin:2px 4px 0 0;display:inline-block">${k}</code>`).join(" ");

    function normalizeKey(s){
      if(!s) return "";
      return s.normalize("NFC").replace(/\u00A0/g,' ').replace(/№/g,'N').replace(/[.,;:()]/g,'').replace(/\s+/g,'_').replace(/-+/g,'_').replace(/__+/g,'_').trim();
    }
    function makeAliases(header){
      const h = header ?? "";
      const withUnderscore = h.replace(/\s+/g,'_');
      const withSpaces = h.replace(/_/g,' ');
      const norm = normalizeKey(h);
      return uniq([h, withUnderscore, withSpaces, h.toLowerCase(), withUnderscore.toLowerCase(), withSpaces.toLowerCase(), norm, norm.toLowerCase()]);
    }
    function buildDataObject(headers,row){
      const obj={};
      headers.forEach((h,i)=>{ makeAliases(h).forEach(alias=>obj[alias] = row[i] ?? ""); });
      return obj;
    }

    // ===== MOBILE SIDEBAR =====
    function openSide(){ $drawerSide.classList.add('open'); $drawerSide.setAttribute('aria-hidden','false'); $scrim.classList.add('show'); $scrim.setAttribute('aria-hidden','false'); }
    function closeSide(){ $drawerSide.classList.remove('open'); $drawerSide.setAttribute('aria-hidden','true'); $scrim.classList.remove('show'); $scrim.setAttribute('aria-hidden','true'); }
    $menuBtn.addEventListener('click', openSide);
    $scrim.addEventListener('click', closeSide);
    window.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSide(); });

    // ===== ТЕМПЛЕЙТЫ (.docx) =====
    async function fetchTemplatesList(){
      try{
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
        const res = await fetch(apiUrl);
        if(!res.ok) throw new Error("GitHub API error");
        const files = await res.json();
        templatesMeta = files.filter(f=>/\.docx$/i.test(f.name)).map(f=>({name:f.name, url:f.download_url}));
        renderTemplates();
      }catch(e){
        $sidebarList.innerHTML = "Ошибка загрузки шаблонов";
        $tplListMobile.innerHTML = "Ошибка загрузки шаблонов";
      }
    }
    function renderTemplates(){
      const filter = v => (t)=> t.name.toLowerCase().includes(v.trim().toLowerCase());
      const renderList = (container, query)=>{
        if(!templatesMeta.length){ container.innerHTML = "Нет .docx-шаблонов"; return; }
        container.innerHTML = templatesMeta.filter(filter(query||"")).map((t,idx)=>
          `<button class="tpl-btn ${selectedTemplate && selectedTemplate.name===t.name?'active':''}" onclick="selectTemplate(${idx}, '${container.id}')" title="${t.name.replace(/\.docx$/i,'')}">${t.name.replace(/\.docx$/i,'')}</button>`
        ).join("");
      };
      renderList($sidebarList, $tplSearch.value||"");
      renderList($tplListMobile, $tplSearchMobile.value||"");
    }
    window.selectTemplate = async function(idx, fromId){
      selectedTemplate = templatesMeta[idx];
      renderTemplates();
      if(fromId==='tplListMobile' && isMobile()) closeSide();
      setError($errorTpl,"");
      await updateTplTags();
      triggerAutoGenerate();
    }
    $tplSearch.addEventListener('input', renderTemplates);
    $tplSearchMobile.addEventListener('input', renderTemplates);

    // Извлечь [[теги]] из docx
    async function extractDocxTags(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error("Не удалось загрузить шаблон");
        const ab = await res.arrayBuffer();
        const zip = new PizZip(ab);
        const xmlNames = Object.keys(zip.files).filter(n=>n.startsWith('word/') && n.endsWith('.xml'));
        const tagSet = new Set();
        const rgx = /\[\[\s*([^\]]+?)\s*\]\]/g;
        xmlNames.forEach(name=>{
          try{
            const txt = zip.files[name].asText();
            let m; while((m=rgx.exec(txt))!==null){ tagSet.add(m[1].trim().split('|')[0].trim()); }
          }catch(_){}
        });
        return Array.from(tagSet).sort((a,b)=>a.localeCompare(b));
      }catch(e){ return []; }
    }
    async function updateTplTags(){
      if(!selectedTemplate){ currentTplTags=[]; return; }
      currentTplTags = await extractDocxTags(selectedTemplate.url);
      $tplTags.innerHTML = renderChips(currentTplTags);
      updateDiagnostics();
    }

    // ===== GOOGLE SHEETS =====
    async function loadGoogleSheet(sheetId){
      try{
        const res = await fetch(csvUrlFromSheetId(sheetId));
        if(!res.ok) throw new Error("Не удалось загрузить таблицу (проверьте доступ по ссылке)");
        const csv = await res.text();
        const wb = XLSX.read(csv,{type:'string'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws,{header:1});
        if(!json.length) throw new Error("Пустая таблица");
        excelHeaders = json[0].map(h=>(h??"").toString().trim());
        excelRows = json.slice(1);
        renderRegistryTable();
        $sheetHeaders.innerHTML = renderChips(excelHeaders);
        updateDiagnostics();
        refreshSmartFilter(); // первичное применение фильтра
      }catch(e){
        excelHeaders=[]; excelRows=[];
        renderRegistryTable();
        $sheetHeaders.innerHTML = "—";
        setError($errorTpl, e.message || "Ошибка загрузки таблицы");
        updateDiagnostics();
      }
    }
    function renderRegistryTable(){
      if(!excelHeaders.length){ $tableWrap.innerHTML=""; return; }
      let html = `<table><thead><tr>`;
      excelHeaders.forEach(h=> html += `<th>${h}</th>`);
      html += `</tr></thead><tbody>`;
      excelRows.forEach((row,i)=>{
        html += `<tr onclick="selectRowIndex(${i})">`;
        excelHeaders.forEach((h,j)=> html += `<td>${row[j] ?? ''}</td>`);
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      $tableWrap.innerHTML = html;
    }
    window.selectRowIndex = function(i){
      // Выбор из таблицы в скрытом режиме — обновим селект и сгенерим письмо
      populateRecordSelect([i]);
      $recordSelect.value = String(i);
      triggerAutoGenerate();
      // прокрутка к превью
      document.querySelector('#preview').scrollIntoView({behavior:'smooth', block:'start'});
    }

    // ===== ИНТЕЛЛЕКТУАЛЬНЫЕ ФИЛЬТРЫ =====
    // Поддержка:
    //   - общий поиск по всем полям: любое слово/фраза
    //   - точечные фильтры: Ключ=Значение (ключ = имя столбца; значение можно в "кавычках")
    //   - несколько фильтров через пробел: Филиал="Тихорецкие электрические сети" ОС=Ростелеком 123
    function parseSmartQuery(q){
      const tokens = [];
      let cur = '', inQuotes = false;
      for(let i=0;i<q.length;i++){
        const ch = q[i];
        if(ch === '"' || ch === '«' || ch === '»'){ inQuotes = !inQuotes; continue; }
        if(!inQuotes && /\s/.test(ch)){
          if(cur.trim()) tokens.push(cur.trim());
          cur = '';
        } else {
          cur += ch;
        }
      }
      if(cur.trim()) tokens.push(cur.trim());
      return tokens;
    }
    function applySmartFilter(q){
      if(!excelRows.length) return [];
      const tokens = parseSmartQuery(q);
      const headerIdx = new Map(excelHeaders.map((h,i)=>[h,i]));
      // Разделим на пары key=value и свободные строки
      const pairs = [];
      const free = [];
      tokens.forEach(t=>{
        const eq = t.indexOf('=');
        if(eq>0){
          const key = t.slice(0,eq).trim();
          const val = t.slice(eq+1).trim();
          pairs.push({key, val});
        } else {
          free.push(t);
        }
      });
      // Функция сопоставления ячейки
      const matchVal = (cell,needle) => String(cell??'').toLowerCase().includes(String(needle).toLowerCase());
      const rowsIdx = [];
      for(let i=0;i<excelRows.length;i++){
        const row = excelRows[i];
        let ok = true;
        // key=value — все должны совпасть
        for(const {key,val} of pairs){
          // ищем индекс колонки (гибко: с алиасами)
          let colIndex = headerIdx.get(key);
          if(colIndex === undefined){
            // пробуем найти по алиасам
            const target = key.toLowerCase();
            for(let c=0;c<excelHeaders.length;c++){
              const aliases = makeAliases(excelHeaders[c]).map(a=>a.toLowerCase());
              if(aliases.includes(target)){ colIndex = c; break; }
            }
          }
          if(colIndex === undefined || !matchVal(row[colIndex], val)){ ok = false; break; }
        }
        if(!ok) continue;
        // свободные слова — встречаются в ЛЮБОЙ колонке
        for(const word of free){
          const hit = row.some(cell => matchVal(cell, word));
          if(!hit){ ok = false; break; }
        }
        if(ok) rowsIdx.push(i);
      }
      return rowsIdx;
    }
    function populateRecordSelect(indexes){
      // Заполняем выпадающий список краткой карточкой записи
      const makeLabel = (i)=>{
        const row = excelRows[i]||[];
        const pick = (name)=> row[(excelHeaders.indexOf(name))] || "";
        const fio = pick("Кому_ФИО") || pick("ФИО") || "";
        const fil = pick("Филиал") || "";
        const tu  = pick("Номер_ТУ") || pick("Номер_документа") || "";
        const os  = pick("ОС") || "";
        let parts = [];
        if(fio) parts.push(fio);
        if(fil) parts.push(fil);
        if(os) parts.push(os);
        if(tu) parts.push(`ТУ:${tu}`);
        const label = parts.join(" • ") || `Строка ${i+2}`;
        return `${label}`;
      };
      $recordSelect.innerHTML = `<option value="">— выберите запись —</option>` + indexes.slice(0,500).map(i=>`<option value="${i}">${makeLabel(i)}</option>`).join("");
    }
    function refreshSmartFilter(){
      const q = $smartQuery.value || "";
      const idxs = applySmartFilter(q);
      $matchInfo.textContent = `Совпадений: ${idxs.length}`;
      populateRecordSelect(idxs);
      // Автовыбор одной найденной строки
      if(idxs.length === 1){
        $recordSelect.value = String(idxs[0]);
      } else {
        $recordSelect.value = "";
      }
      triggerAutoGenerate(); // письмо формируем автоматически
    }
    $smartQuery.addEventListener('input', ()=>{ refreshSmartFilter(); });

    $recordSelect.addEventListener('change', ()=>{ triggerAutoGenerate(); });

    // ===== ДИАГНОСТИКА =====
    function updateDiagnostics(){
      const hdrAliases = new Map();
      excelHeaders.forEach(h => makeAliases(h).forEach(a => hdrAliases.set(a,h)));
      const missing = [];
      const used = new Set();
      currentTplTags.forEach(tag=>{
        const cands = uniq([tag, tag.toLowerCase(), normalizeKey(tag), normalizeKey(tag).toLowerCase(), tag.replace(/\s+/g,'_'), tag.replace(/_/g,' ')]);
        let matched = null;
        for(const c of cands){ if(hdrAliases.has(c)){ matched = hdrAliases.get(c); break; } }
        if(!matched) missing.push(tag); else used.add(matched);
      });
      const unused = excelHeaders.filter(h=>!used.has(h));
      $missingInSheet.innerHTML = renderChips(missing);
      $unusedHeaders.innerHTML = renderChips(unused);
    }

    // ===== ГЕНЕРАЦИЯ DOCX + PREVIEW (автоматически) =====
    async function autoGenerate(){
      setError($errorTpl,""); lastGeneratedBlob = null;
      const rec = $recordSelect.value;
      if(!selectedTemplate || !rec){ clearPreview(); return; }

      try{
        const res = await fetch(selectedTemplate.url);
        if(!res.ok) throw new Error("Не удалось загрузить шаблон");
        const ab = await res.arrayBuffer();
        const zip = new PizZip(ab);

        const doc = new window.docxtemplater(zip, { delimiters:{start:'[[', end:']]'} });
        const data = buildDataObject(excelHeaders, excelRows[parseInt(rec)]);
        doc.setData(data);
        try{ doc.render(); }
        catch(e){
          let details = "";
          if(e.properties?.errors){ details = e.properties.errors.map(err=>`• ${err.properties?.explanation || err.message || "Ошибка"}`).join("\n"); }
          throw new Error("Ошибка формирования шаблона.\n" + details);
        }

        const out = doc.getZip().generate({ type:"blob" });
        lastGeneratedBlob = out;

        const buf = await out.arrayBuffer();
        const result = await window.mammoth.convertToHtml({ arrayBuffer:buf });
        $preview.innerHTML = result.value || "<i>(Превью пустое — но .docx сформирован)</i>";
        $downloadBtn.disabled = false;
        $copyBtn.disabled = false;

        // На мобильном — к превью
        if(isMobile()){ document.querySelector('#preview').scrollIntoView({behavior:'smooth', block:'start'}); }
      }catch(e){
        console.error(e); setError($errorTpl, e.message || "Ошибка формирования");
        $downloadBtn.disabled = true; $copyBtn.disabled = true;
      }
    }
    function triggerAutoGenerate(){
      // Делаем минимальную задержку, чтобы не «дёргать» при быстром вводе
      clearTimeout(triggerAutoGenerate._t);
      triggerAutoGenerate._t = setTimeout(autoGenerate, 150);
    }

    // Скачать .docx
    function downloadDocx(){
      if(!lastGeneratedBlob || !selectedTemplate) return;
      const a = document.createElement("a");
      const url = URL.createObjectURL(lastGeneratedBlob);
      a.href = url;
      const clean = selectedTemplate.name.replace(/\.docx$/i,'');
      const rec = $recordSelect.value ? (parseInt($recordSelect.value)+2) : 'X';
      a.download = `${clean}_строка_${rec}.docx`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    document.getElementById('downloadBtn').addEventListener('click', downloadDocx);

    // Копировать письмо в буфер
    async function copyLetter(){
      const html = $preview.innerHTML;
      if(!html) return;
      try{
        // Пытаемся скопировать как HTML + Text
        const blobHtml = new Blob([html], { type: "text/html" });
        const blobText = new Blob([ $preview.innerText || $preview.textContent || "" ], { type: "text/plain" });
        const data = [ new ClipboardItem({ "text/html": blobHtml, "text/plain": blobText }) ];
        await navigator.clipboard.write(data);
      }catch(_){
        // Фолбэк
        const range = document.createRange();
        range.selectNodeContents($preview);
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(range);
        document.execCommand('copy');
        sel.removeAllRanges();
      }
      // краткий визуальный отклик
      const btn = document.getElementById('copyBtn');
      const old = btn.textContent; btn.textContent = "Скопировано!";
      setTimeout(()=> btn.textContent = old, 1200);
    }
    document.getElementById('copyBtn').addEventListener('click', copyLetter);

    // Тумблеры «Показать…»
    function toggle(el){ el.classList.toggle('open'); }
    $toggleRegistry.addEventListener('click', ()=> toggle($registryDrawer));
    $toggleDiag.addEventListener('click', ()=> toggle($diagDrawer));

    // Инициализация
    (function init(){
      // первичная загрузка
      fetchTemplatesList();
      loadGoogleSheet(DEFAULT_GOOGLE_SHEET_ID);
      // автоподстановка фокуса в фильтр
      setTimeout(()=> $smartQuery.focus(), 300);
    })();
  </script>
</body>
</html>
