<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Автоматизация писем через GitHub и Google Таблицы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6fa; margin: 0; }
    #container { display: flex; min-height: 100vh; }
    #sidebar { width: 240px; background: #263e5f; color: #fff; padding: 30px 10px 10px 10px; box-shadow: 2px 0 4px rgba(0,0,0,0.03);}
    #sidebar button { display: block; width: 100%; margin: 10px 0; padding: 12px; background: #385980; border: none; color: #fff; font-size: 16px; border-radius: 7px; cursor: pointer; text-align: left;}
    #sidebar button.active { background: #21a4e4; font-weight: bold;}
    #main { flex: 2; padding: 24px; }
    #right { width: 520px; background: #fff; padding: 20px; border-left: 1px solid #e5e8ee; overflow-x:auto;}
    .excel-table { width: 100%; border-collapse: collapse; background: #fff; }
    .excel-table th, .excel-table td { border: 1px solid #d1d9e6; padding: 7px 10px; }
    .excel-table tr:hover { background: #eaf6ff; cursor: pointer; }
    #templateArea { min-height: 180px; background: #f7fafd; border: 1px solid #e0e7f4; border-radius: 7px; padding: 15px; margin-bottom: 18px; }
    #rowInput { margin-bottom: 10px;}
    #finalLetter { background: #f6f8fb; border-radius: 7px; padding: 18px; font-size: 16px; min-height: 180px; border: 1px solid #e0e7f4; margin-top:12px;}
    #uploadExcel, #loadGoogleSheetBtn { margin-top: 16px;}
    @media (max-width:1100px) { #container { flex-direction: column; } #sidebar, #right { width: 100%;} #main { padding: 10px;} }
    #sheetLinkInput {width:100%;padding:5px;margin-bottom:12px;}
    .letter-html table { border-collapse: collapse; }
    .letter-html th, .letter-html td { border:1px solid #d1d9e6; padding: 5px 8px; }
  </style>
</head>
<body>
  <div id="container">
    <!-- Левая панель — шаблоны писем из GitHub -->
    <div id="sidebar">
      <h3>Шаблоны писем</h3>
      <div id="templatesList">Загрузка...</div>
    </div>
    <!-- Центр — таблица Google Sheets -->
    <div id="main">
      <h3>Реестр (Google Таблица)</h3>
      <input type="text" id="sheetLinkInput" placeholder="Вставь ссылку на Google Таблицу или её ID">
      <button id="loadGoogleSheetBtn" onclick="loadGoogleSheet()">Загрузить таблицу</button>
      <div id="tableArea"></div>
    </div>
    <!-- Правая часть — выбор строки и шаблон письма -->
    <div id="right">
      <h3>Форма письма</h3>
      <div id="templateArea" class="letter-html">Выберите шаблон письма и строку из реестра.</div>
      <input type="number" id="rowInput" placeholder="Введите номер строки" min="2" style="width: 100%;">
      <button onclick="generateLetter()" style="width: 100%; margin-bottom:15px;">Сформировать письмо</button>
      <div id="finalLetter" class="letter-html"></div>
    </div>
  </div>
  <script>
    // --- Настройки GitHub ---
    const GITHUB_USER = "anatoliy031";
    const GITHUB_REPO = "letter-automation";
    const GITHUB_TEMPLATES_FOLDER = "templates";

    // --- 1. Загрузка списка шаблонов из GitHub ---
    let templatesMeta = [];    // [{name, url, raw_url}]
    let currentTemplateName = '';
    let currentTemplateContent = '';
    let excelData = [];
    let headers = [];
    let googleSheetUrl = '';

    // Загрузка списка файлов-шаблонов из GitHub
    async function fetchTemplatesList() {
      const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${GITHUB_TEMPLATES_FOLDER}`;
      const res = await fetch(apiUrl);
      if (!res.ok) {
        document.getElementById('templatesList').innerHTML = "Не удалось загрузить список шаблонов!";
        return;
      }
      const files = await res.json();
      // Оставляем только .html (а можно и .txt, .md — расширь если нужно)
      templatesMeta = files.filter(f => /\.html$/i.test(f.name));
      renderTemplatesList();
    }

    function renderTemplatesList() {
      let html = '';
      templatesMeta.forEach((tpl, idx) => {
        html += `<button onclick="selectTemplate('${tpl.name}')" id="tplbtn-${idx}">${tpl.name.replace(/\.html$/i, '')}</button>`;
      });
      document.getElementById('templatesList').innerHTML = html || 'Нет шаблонов';
    }

    // --- 2. Загрузка содержимого шаблона по клику ---
    async function selectTemplate(name) {
      currentTemplateName = name;
      currentTemplateContent = '';
      // Подсветка
      document.querySelectorAll('#templatesList button').forEach(btn => btn.classList.remove('active'));
      const idx = templatesMeta.findIndex(t=>t.name===name);
      if (idx>=0) document.getElementById(`tplbtn-${idx}`).classList.add('active');
      // RAW url
      const rawUrl = templatesMeta[idx].download_url;
      const res = await fetch(rawUrl);
      if (!res.ok) {
        document.getElementById('templateArea').innerText = "Не удалось загрузить шаблон";
        return;
      }
      const text = await res.text();
      currentTemplateContent = text;
      document.getElementById('templateArea').innerHTML = text;
      document.getElementById('finalLetter').innerHTML = '';
    }

    // --- 3. Загрузка Google Таблицы ---
    async function loadGoogleSheet() {
      let url = document.getElementById('sheetLinkInput').value.trim();
      if (!url) {
        alert('Вставьте ссылку на Google Таблицу или её ID!');
        return;
      }
      // Поддержка ID или URL
      let sheetId = '';
      if (/docs.google.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/.test(url)) {
        sheetId = url.match(/\/d\/([a-zA-Z0-9-_]+)/)[1];
      } else {
        sheetId = url;
      }
      googleSheetUrl = sheetId;
      // Получаем CSV из первой вкладки
      let csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
      const res = await fetch(csvUrl);
      if (!res.ok) {
        document.getElementById('tableArea').innerHTML = "Не удалось загрузить Google Таблицу!";
        return;
      }
      const csv = await res.text();
      // Используем SheetJS для парсинга
      const workbook = XLSX.read(csv, {type:'string'});
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(firstSheet, {header:1});
      headers = json[0];
      excelData = json.slice(1);
      renderTable();
    }

    function renderTable() {
      let html = `<table class="excel-table"><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += `</tr>`;
      excelData.forEach((row, idx) => {
        html += `<tr onclick="selectRow(${idx})">`;
        headers.forEach((h,j) => html += `<td>${row[j]||''}</td>`);
        html += `</tr>`;
      });
      html += `</table>`;
      document.getElementById('tableArea').innerHTML = html;
    }

    function selectRow(idx) {
      document.getElementById('rowInput').value = idx+2;
      generateLetter();
    }

    // --- 4. Формирование итогового письма ---
    function generateLetter() {
      if (!currentTemplateContent) {
        alert('Сначала выберите шаблон!');
        return;
      }
      const rowNum = parseInt(document.getElementById('rowInput').value);
      if (isNaN(rowNum) || rowNum < 2 || rowNum-2 >= excelData.length) {
        alert('Введите корректный номер строки!');
        return;
      }
      const row = excelData[rowNum-2];
      let letter = currentTemplateContent;

      // Подстановка всех {Поле} значений
      headers.forEach((h, j) => {
        const regex = new RegExp(`{${h}}`, 'g');
        letter = letter.replace(regex, row[j]||'');
      });

      document.getElementById('finalLetter').innerHTML = letter;
    }

    // Загрузка шаблонов при старте
    fetchTemplatesList();
  </script>
</body>
</html>
